"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9108],{3905:(e,n,o)=>{o.d(n,{Zo:()=>l,kt:()=>C});var t=o(7294);function r(e,n,o){return n in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o,e}function u(e,n){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),o.push.apply(o,t)}return o}function a(e){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?u(Object(o),!0).forEach((function(n){r(e,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):u(Object(o)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))}))}return e}function s(e,n){if(null==e)return{};var o,t,r=function(e,n){if(null==e)return{};var o,t,r={},u=Object.keys(e);for(t=0;t<u.length;t++)o=u[t],n.indexOf(o)>=0||(r[o]=e[o]);return r}(e,n);if(Object.getOwnPropertySymbols){var u=Object.getOwnPropertySymbols(e);for(t=0;t<u.length;t++)o=u[t],n.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var i=t.createContext({}),p=function(e){var n=t.useContext(i),o=n;return e&&(o="function"==typeof e?e(n):a(a({},n),e)),o},l=function(e){var n=p(e.components);return t.createElement(i.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef((function(e,n){var o=e.components,r=e.mdxType,u=e.originalType,i=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),c=p(o),m=r,C=c["".concat(i,".").concat(m)]||c[m]||d[m]||u;return o?t.createElement(C,a(a({ref:n},l),{},{components:o})):t.createElement(C,a({ref:n},l))}));function C(e,n){var o=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var u=o.length,a=new Array(u);a[0]=m;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s[c]="string"==typeof e?e:r,a[1]=s;for(var p=2;p<u;p++)a[p]=o[p];return t.createElement.apply(null,a)}return t.createElement.apply(null,o)}m.displayName="MDXCreateElement"},5162:(e,n,o)=>{o.d(n,{Z:()=>a});var t=o(7294),r=o(6010);const u={tabItem:"tabItem_Ymn6"};function a(e){let{children:n,hidden:o,className:a}=e;return t.createElement("div",{role:"tabpanel",className:(0,r.Z)(u.tabItem,a),hidden:o},n)}},4866:(e,n,o)=>{o.d(n,{Z:()=>A});var t=o(7462),r=o(7294),u=o(6010),a=o(2466),s=o(6550),i=o(1980),p=o(7392),l=o(12);function c(e){return function(e){return r.Children.map(e,(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:n,label:o,attributes:t,default:r}}=e;return{value:n,label:o,attributes:t,default:r}}))}function d(e){const{values:n,children:o}=e;return(0,r.useMemo)((()=>{const e=n??c(o);return function(e){const n=(0,p.l)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,o])}function m(e){let{value:n,tabValues:o}=e;return o.some((e=>e.value===n))}function C(e){let{queryString:n=!1,groupId:o}=e;const t=(0,s.k6)(),u=function(e){let{queryString:n=!1,groupId:o}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!o)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return o??null}({queryString:n,groupId:o});return[(0,i._X)(u),(0,r.useCallback)((e=>{if(!u)return;const n=new URLSearchParams(t.location.search);n.set(u,e),t.replace({...t.location,search:n.toString()})}),[u,t])]}function k(e){const{defaultValue:n,queryString:o=!1,groupId:t}=e,u=d(e),[a,s]=(0,r.useState)((()=>function(e){let{defaultValue:n,tabValues:o}=e;if(0===o.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!m({value:n,tabValues:o}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${o.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const t=o.find((e=>e.default))??o[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:u}))),[i,p]=C({queryString:o,groupId:t}),[c,k]=function(e){let{groupId:n}=e;const o=function(e){return e?`docusaurus.tab.${e}`:null}(n),[t,u]=(0,l.Nk)(o);return[t,(0,r.useCallback)((e=>{o&&u.set(e)}),[o,u])]}({groupId:t}),R=(()=>{const e=i??c;return m({value:e,tabValues:u})?e:null})();(0,r.useLayoutEffect)((()=>{R&&s(R)}),[R]);return{selectedValue:a,selectValue:(0,r.useCallback)((e=>{if(!m({value:e,tabValues:u}))throw new Error(`Can't select invalid tab value=${e}`);s(e),p(e),k(e)}),[p,k,u]),tabValues:u}}var R=o(2389);const v={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function S(e){let{className:n,block:o,selectedValue:s,selectValue:i,tabValues:p}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.o5)(),d=e=>{const n=e.currentTarget,o=l.indexOf(n),t=p[o].value;t!==s&&(c(n),i(t))},m=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const o=l.indexOf(e.currentTarget)+1;n=l[o]??l[0];break}case"ArrowLeft":{const o=l.indexOf(e.currentTarget)-1;n=l[o]??l[l.length-1];break}}n?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,u.Z)("tabs",{"tabs--block":o},n)},p.map((e=>{let{value:n,label:o,attributes:a}=e;return r.createElement("li",(0,t.Z)({role:"tab",tabIndex:s===n?0:-1,"aria-selected":s===n,key:n,ref:e=>l.push(e),onKeyDown:m,onClick:d},a,{className:(0,u.Z)("tabs__item",v.tabItem,a?.className,{"tabs__item--active":s===n})}),o??n)})))}function E(e){let{lazy:n,children:o,selectedValue:t}=e;const u=(Array.isArray(o)?o:[o]).filter(Boolean);if(n){const e=u.find((e=>e.props.value===t));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},u.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==t}))))}function T(e){const n=k(e);return r.createElement("div",{className:(0,u.Z)("tabs-container",v.tabList)},r.createElement(S,(0,t.Z)({},e,n)),r.createElement(E,(0,t.Z)({},e,n)))}function A(e){const n=(0,R.Z)();return r.createElement(T,(0,t.Z)({key:String(n)},e))}},8546:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>C,frontMatter:()=>s,metadata:()=>p,toc:()=>c});var t=o(7462),r=(o(7294),o(3905)),u=o(4866),a=o(5162);const s={title:"2. Lock",tags:["Backend","DataBase","MySQL","TypeORM","ConcurrencyControl","Lock"],sidebar_position:2},i="2. Lock",p={unversionedId:"backend/database/concurrency-control/lock",id:"backend/database/concurrency-control/lock",title:"2. Lock",description:"\ub77d(Lock)\uc774\ub780 \ub3d9\uc77c\ud55c \uc790\uc6d0\uc5d0 \uc811\uadfc\ud560 \ub54c, \ub370\uc774\ud130\uc758 \uc77c\uad00\uc131\uacfc \ubb34\uacb0\uc131\uc744 \uc720\uc9c0\ud558\uae30 \uc704\ud574 \uc790\uc6d0\uc5d0 \ub300\ud55c \uc811\uadfc\uc744 \uc81c\uc5b4\ud558\ub294 \uba54\ucee4\ub2c8\uc998\uc774\ub2e4.",source:"@site/docs/02-backend/02-database/02-concurrency-control/02-lock.mdx",sourceDirName:"02-backend/02-database/02-concurrency-control",slug:"/backend/database/concurrency-control/lock",permalink:"/backend/database/concurrency-control/lock",draft:!1,tags:[{label:"Backend",permalink:"/tags/backend"},{label:"DataBase",permalink:"/tags/data-base"},{label:"MySQL",permalink:"/tags/my-sql"},{label:"TypeORM",permalink:"/tags/type-orm"},{label:"ConcurrencyControl",permalink:"/tags/concurrency-control"},{label:"Lock",permalink:"/tags/lock"}],version:"current",sidebarPosition:2,frontMatter:{title:"2. Lock",tags:["Backend","DataBase","MySQL","TypeORM","ConcurrencyControl","Lock"],sidebar_position:2},sidebar:"docs",previous:{title:"1. Schedule",permalink:"/backend/database/concurrency-control/schedule"},next:{title:"3. Isolation Level",permalink:"/backend/database/concurrency-control/isolation-level"}},l={},c=[{value:"\ub77d\uc744 \uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc558\uc744 \ub54c",id:"\ub77d\uc744-\uc0ac\uc6a9\ud558\uc9c0-\uc54a\uc558\uc744-\ub54c",level:2},{value:"\ub099\uad00\uc801 \ub77d (Optimistic Lock)",id:"\ub099\uad00\uc801-\ub77d-optimistic-lock",level:2},{value:"\ub3d9\uc791 \ubc29\uc2dd",id:"\ub3d9\uc791-\ubc29\uc2dd",level:3},{value:"\uc7a5\uc810",id:"\uc7a5\uc810",level:3},{value:"\ub2e8\uc810",id:"\ub2e8\uc810",level:3},{value:"Test With TypeORM",id:"test-with-typeorm",level:3},{value:"\ube44\uad00\uc801 \ub77d (Pessimistic Lock)",id:"\ube44\uad00\uc801-\ub77d-pessimistic-lock",level:2},{value:"\ube44\uad00\uc801 \ub77d vs \ub099\uad00\uc801 \ub77d",id:"\ube44\uad00\uc801-\ub77d-vs-\ub099\uad00\uc801-\ub77d",level:3},{value:"\uc77d\uae30 \ub77d (Read Lock) &amp; \uacf5\uc720 \ub77d (Shared Lock)",id:"\uc77d\uae30-\ub77d-read-lock--\uacf5\uc720-\ub77d-shared-lock",level:2},{value:"\uc7a5\uc810",id:"\uc7a5\uc810-1",level:3},{value:"\ub2e8\uc810",id:"\ub2e8\uc810-1",level:3},{value:"Test With TypeORM",id:"test-with-typeorm-1",level:3},{value:"\uc4f0\uae30 \ub77d (Write Lock) &amp; \ubc30\ud0c0 \ub77d (Exclusive Lock)",id:"\uc4f0\uae30-\ub77d-write-lock--\ubc30\ud0c0-\ub77d-exclusive-lock",level:2},{value:"\uc7a5\uc810",id:"\uc7a5\uc810-2",level:3},{value:"\ub2e8\uc810",id:"\ub2e8\uc810-2",level:3},{value:"Test With TypeORM",id:"test-with-typeorm-2",level:3},{value:"NOWAIT \uc635\uc158 \uc124\uc815\uc2dc",id:"nowait-\uc635\uc158-\uc124\uc815\uc2dc",level:4}],d={toc:c},m="wrapper";function C(e){let{components:n,...o}=e;return(0,r.kt)(m,(0,t.Z)({},d,o,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"2-lock"},"2. Lock"),(0,r.kt)("p",null,"\ub77d(Lock)\uc774\ub780 \ub3d9\uc77c\ud55c \uc790\uc6d0\uc5d0 \uc811\uadfc\ud560 \ub54c, \ub370\uc774\ud130\uc758 \uc77c\uad00\uc131\uacfc \ubb34\uacb0\uc131\uc744 \uc720\uc9c0\ud558\uae30 \uc704\ud574 \uc790\uc6d0\uc5d0 \ub300\ud55c \uc811\uadfc\uc744 \uc81c\uc5b4\ud558\ub294 \uba54\ucee4\ub2c8\uc998\uc774\ub2e4."),(0,r.kt)("h2",{id:"\ub77d\uc744-\uc0ac\uc6a9\ud558\uc9c0-\uc54a\uc558\uc744-\ub54c"},"\ub77d\uc744 \uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc558\uc744 \ub54c"),(0,r.kt)("p",null,"\ub77d\uc758 \uc885\ub958\uc5d0 \ub300\ud574\uc11c \uc54c\uc544\ubcf4\uae30 \uc804\uc5d0, \ub77d\uc744 \uc0ac\uc6a9\ud558\uc9c0 \uc54a\uc558\uc744 \ub54c \ub3d9\uc2dc\uc131 \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud560 \uc218 \uc788\ub294 \uc0c1\ud669\uc744 \uac04\ub2e8\ud558\uac8c \uc7ac\ud604\ud574\ubcf4\uc790."),(0,r.kt)("p",null,"\ud14c\uc2a4\ud2b8 \ud658\uacbd\uc758 DB\ub294 MySQL8.0\uc744 \uc0ac\uc6a9\ud558\uc600\ub2e4. \ud574\ub2f9 \uae00\uc5d0\uc11c \uc0ac\uc6a9\ub418\ub294 \uc608\uc2dc\ucf54\ub4dc\ub294 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/chihunmanse/concurrency-test"},"GitHub")," \uc5d0\uc11c\ub3c4 \ud655\uc778\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:"title='coupon.entity.ts'",title:"'coupon.entity.ts'"},'@Entity()\nexport class Coupon {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  code: string;\n\n  @Column({ default: false })\n  isRedeemed: boolean;\n\n  @ManyToOne(() => User, (user) => user.coupons, { nullable: true })\n  @JoinColumn({ name: "user_id", referencedColumnName: "id" })\n  user: User;\n\n  @Column({ name: "user_id", nullable: true })\n  userId: number;\n\n  @VersionColumn()\n  version: number;\n}\n')),(0,r.kt)("p",null,"\ucfe0\ud3f0\uc740 \ud558\ub098\ub2f9 \ud55c \uba85\uc758 \uc720\uc800\uc5d0\uac8c\ub9cc \ubc1c\ud589\ub420 \uc218 \uc788\ub2e4. \uc720\uc800\uac00 \ub4f1\ub85d(\ubc1c\ud589)\ub41c \ucfe0\ud3f0\uc740 ",(0,r.kt)("inlineCode",{parentName:"p"},"isRedeemed")," \uce7c\ub7fc\uc774 true\ub85c \uc5c5\ub370\uc774\ud2b8 \ub41c\ub2e4."),(0,r.kt)(u.Z,{mdxType:"Tabs"},(0,r.kt)(a.Z,{value:"coupon.service.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"  async assignCouponWithoutLock(\n    userId: number,\n  ): Promise<{ readCoupon: Coupon; saveCoupon: Coupon }> {\n    const coupon = await this.couponRepository.findOne({\n      where: { isRedeemed: false },\n      order: { id: 'ASC' },\n    });\n\n    if (!coupon) {\n      throw new Error('No available coupons');\n    }\n\n    coupon.isRedeemed = true;\n    coupon.userId = userId;\n\n    return {\n      readCoupon: coupon,\n      saveCoupon: await this.couponRepository.save(coupon),\n    };\n  }\n"))),(0,r.kt)(a.Z,{value:"coupon.lock.spec.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'it("should handle concurrent requests without locks", async () => {\n  const user1 = await userRepository.save({ name: "user1" });\n  const user2 = await userRepository.save({ name: "user2" });\n  await couponRepository.save({ code: "WITHOUT_LOCK_COUPON" });\n\n  const result1Promise = service.assignCouponWithoutLock(user1.id);\n  const result2Promise = service.assignCouponWithoutLock(user2.id);\n\n  const [result1, result2] = await Promise.all([\n    result1Promise,\n    result2Promise,\n  ]);\n\n  expect(result1.readCoupon.code).toBe("WITHOUT_LOCK_COUPON");\n  expect(result2.readCoupon.code).toBe("WITHOUT_LOCK_COUPON");\n  expect(result1.saveCoupon.code).toBe("WITHOUT_LOCK_COUPON");\n  expect(result2.saveCoupon.code).toBe("WITHOUT_LOCK_COUPON");\n  expect(result1.saveCoupon.userId).toBe(user1.id);\n  expect(result2.saveCoupon.userId).toBe(user2.id);\n});\n')))),(0,r.kt)("p",null,"\uc544\uc9c1 \ub4f1\ub85d\ub418\uc9c0 \uc54a\uc740 \ucfe0\ud3f0 (",(0,r.kt)("inlineCode",{parentName:"p"},"isRedeemed"),"\uc774 false\uc778 \ucfe0\ud3f0)\uc744 1\uac1c \uc870\ud68c\ud558\uc5ec \uc694\uccad\ud55c \uc720\uc800\uc5d0\uac8c \ub4f1\ub85d\ud574\uc8fc\ub294 \ud568\uc218\ub97c \ube44\ub3d9\uae30\ub85c \ub3d9\uc2dc\uc5d0 \uc694\uccad\ud588\uc744 \ub54c, \ubc1c\uae09\ub420 \uc218 \uc788\ub294 \ucfe0\ud3f0\uc740 \ud558\ub098\ubfd0\uc774\uae30 \ub54c\ubb38\uc5d0 \ud558\ub098\uc758 \uc694\uccad\uc740 \uc2e4\ud328\ud574\uc57c\ud558\uc9c0\ub9cc \ub9c8\uce58 \ub450 \uba85\uc758 \uc720\uc800\uc5d0\uac8c \ubaa8\ub450 \ucfe0\ud3f0\uc774 \ubc1c\uae09\ub41c \uac83\ucc98\ub7fc \ub3d9\uc791\ud558\ub294 \uac83\uc744 \ubcfc \uc218 \uc788\ub2e4."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ucffc\ub9ac"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"  -- \uba3c\uc800 \uc2e4\ud589\ub41c \uc694\uccad\uc758 \uc870\ud68c \ucffc\ub9ac (findOne)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE ((`Coupon`.`isRedeemed` = ?)) ORDER BY `Coupon`.`id` ASC LIMIT 1 -- PARAMETERS: [false]\n  -- \uba3c\uc800 \uc2e4\ud589\ub41c \uc694\uccad\uc758 \uc870\ud68c \ucffc\ub9ac (save)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` IN (?) -- PARAMETERS: [1]\n  -- \uba3c\uc800 \uc2e4\ud589\ub41c \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \ub450 \ubc88\uc9f8\ub85c \uc2e4\ud589\ub41c \uc694\uccad\uc758 \uc870\ud68c \ucffc\ub9ac (findOne)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE ((`Coupon`.`isRedeemed` = ?)) ORDER BY `Coupon`.`id` ASC LIMIT 1 -- PARAMETERS: [false]\n  -- \uba3c\uc800 \uc2e4\ud589\ub41c \uc694\uccad\uc758 \uc5c5\ub370\uc774\ud2b8 \ucffc\ub9ac (save)\n  UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE `id` IN (?) -- PARAMETERS: [1,1,1]\n  -- \ub450 \ubc88\uc9f8\ub85c \uc2e4\ud589\ub41c \uc694\uccad\uc758 \uc870\ud68c \ucffc\ub9ac (save)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` IN (?) -- PARAMETERS: [1]\n  -- \uba3c\uc800 \uc2e4\ud589\ub41c \uc694\uccad\uc758 \uc5c5\ub370\uc774\ud2b8 \ud6c4 \uc870\ud68c \ucffc\ub9ac (save)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` = ? -- PARAMETERS: [1]\n  -- \ub450 \ubc88\uc9f8\ub85c \uc2e4\ud589\ub41c \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \uba3c\uc800 \uc2e4\ud589\ub41c \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \ucee4\ubc0b\n  COMMIT\n  -- \ub450 \ubc88\uc9f8\ub85c \uc2e4\ud589\ub41c \uc694\uccad\uc758 \uc5c5\ub370\uc774\ud2b8, \uc870\ud68c \ucffc\ub9ac (save)\n  UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE `id` IN (?) -- PARAMETERS: [1,2,1]\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` = ? -- PARAMETERS: [1]\n  -- \ub450 \ubc88\uc9f8\ub85c \uc2e4\ud589\ub41c \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \ucee4\ubc0b\n  COMMIT\n")))),(0,r.kt)("p",null,"\uc704\ucc98\ub7fc \ub3d9\uc77c\ud55c \uc790\uc6d0\uc5d0 \ub300\ud55c \ub3d9\uc2dc\ub2e4\ubc1c\uc801\uc778 \uc694\uccad\uc774 \uc788\uc744 \ub54c \ubc1c\uc0dd\ud560 \uc218 \uc788\ub294 \ubb38\uc81c\ub97c \ubc29\uc9c0\ud558\uae30 \uc704\ud55c \ubc29\ubc95\uc73c\ub85c Lock\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("h2",{id:"\ub099\uad00\uc801-\ub77d-optimistic-lock"},"\ub099\uad00\uc801 \ub77d (Optimistic Lock)"),(0,r.kt)("p",null,"\ub099\uad00\uc801 \ub77d(Optimistic Lock)\uc740 \ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud560 \uac00\ub2a5\uc131\uc774 \ub0ae\ub2e4\uace0 \uac00\uc815\ud558\uace0, \ub370\uc774\ud130\ubca0\uc774\uc2a4\uc5d0 \ub77d\uc744 \uc124\uc815\ud558\uc9c0 \uc54a\uace0 \ub370\uc774\ud130\uc758 \ucee4\ubc0b \uc804 \ucda9\ub3cc\uc744 \uac10\uc9c0\ud558\ub294 \ubc29\uc2dd\uc774\ub2e4."),(0,r.kt)("h3",{id:"\ub3d9\uc791-\ubc29\uc2dd"},"\ub3d9\uc791 \ubc29\uc2dd"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\ub370\uc774\ud130 \uc77d\uae30 : \ub370\uc774\ud130\ub97c \uc77d\uc744 \ub54c \ubc84\uc804 \uc815\ubcf4\ub97c \ud568\uaed8 \uc77d\ub294\ub2e4. \ubc84\uc804 \uc815\ubcf4\ub294 \ubcf4\ud1b5 \uc5c5\ub370\uc774\ud2b8\ub420 \ub54c\ub9c8\ub2e4 \uc99d\uac00\ud558\ub294 \ubc88\ud638\ub098 \ud0c0\uc784\uc2a4\ud0ec\ud504 \ub4f1\uc73c\ub85c \uad00\ub9ac\ub41c\ub2e4.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"\ub370\uc774\ud130 \uc218\uc815 : \ub370\uc774\ud130\ub97c \uc218\uc815\ud560 \ub54c, \uba3c\uc800 \ub370\uc774\ud130\uc758 \ubc84\uc804 \uc815\ubcf4\ub97c \ud655\uc778\ud55c\ub2e4. \ucc98\uc74c \uc870\ud68c\ud55c \ub370\uc774\ud130 \ubc84\uc804 \uc815\ubcf4\ub97c \uae30\ubc18\uc73c\ub85c \ud604\uc7ac \ub370\uc774\ud130\ubca0\uc774\uc2a4\uc5d0 \uc800\uc7a5\ub41c \ubc84\uc804 \uc815\ubcf4\uac00 \uc77c\uce58\ud558\ub294\uc9c0 \ube44\uad50\ud55c\ub2e4."),(0,r.kt)("p",{parentName:"li"},"\ubc84\uc804\uc774 \uc77c\uce58\ud558\ub294 \uacbd\uc6b0, \ub370\uc774\ud130\uac00 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc5d0 \uc758\ud574 \uc218\uc815\ub418\uc9c0 \uc54a\uc558\uc74c\uc744 \uc758\ubbf8\ud558\uba70, \ub370\uc774\ud130\ub97c \uc218\uc815\ud558\uace0 \ubc84\uc804 \uc815\ubcf4\ub97c \uac31\uc2e0\ud55c\ub2e4."),(0,r.kt)("p",{parentName:"li"},"\ubc84\uc804\uc774 \ubd88\uc77c\uce58\ud558\ub294 \uacbd\uc6b0, \ub370\uc774\ud130\uac00 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc5d0 \uc758\ud574 \uc218\uc815\ub418\uc5c8\uc74c\uc744 \uc758\ubbf8\ud558\uba70, \ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud55c \uac83\uc73c\ub85c \uac04\uc8fc\ud55c\ub2e4. \uc774 \uacbd\uc6b0 \ud2b8\ub79c\uc7ad\uc158\uc744 \ub864\ubc31\ud558\uac70\ub098 \uc5b4\ud50c\ub9ac\ucf00\uc774\uc158 \ub2e8\uc5d0\uc11c \ucda9\ub3cc\uc744 \ucc98\ub9ac\ud55c\ub2e4."))),(0,r.kt)("h3",{id:"\uc7a5\uc810"},"\uc7a5\uc810"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\ub77d \uc624\ubc84\ud5e4\ub4dc \uc5c6\uc74c : \ub099\uad00\uc801 \ub77d\uc740 \ub370\uc774\ud130\ub97c \uc77d\uc744 \ub54c \ub77d\uc744 \uac78\uc9c0 \uc54a\uc73c\ubbc0\ub85c \ub77d\uc744 \uad00\ub9ac\ud558\uace0 \ud574\uc81c\ud558\ub294 \uc624\ubc84\ud5e4\ub4dc\uac00 \uc5c6\uc5b4\uc838 \ub370\uc774\ud130\ubca0\uc774\uc2a4 \uc131\ub2a5\uc774 \ud5a5\uc0c1\ub41c\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ub0ae\uc740 \ub300\uae30 \uc2dc\uac04 : \ub77d\uc744 \uae30\ub2e4\ub9b4 \ud544\uc694\uac00 \uc5c6\uae30 \ub54c\ubb38\uc5d0 \ub370\uc774\ud130\ubca0\uc774\uc2a4 \ud2b8\ub79c\uc7ad\uc158\uc758 \ub300\uae30 \uc2dc\uac04\uc774 \uc9e7\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ub370\ub4dc\ub77d \uc5c6\uc74c : \ub370\uc774\ud130\ub97c \uc218\uc815\ud558\uae30 \uc804\uc5d0 \ub77d\uc744 \uac78\uc9c0 \uc54a\uae30 \ub54c\ubb38\uc5d0 \ub370\ub4dc\ub77d \uc0c1\ud669\uc774 \ubc29\uc9c0\ub41c\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\uc720\uc5f0\ud55c \ucda9\ub3cc \ucc98\ub9ac : \ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud588\uc744 \ub54c \ub864\ubc31\ud558\uac70\ub098 \uc7ac\uc2dc\ub3c4\ud558\ub294 \ub85c\uc9c1 \ub4f1\uc744 \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc5d0\uc11c \uc720\uc5f0\ud558\uac8c \ucc98\ub9ac\ud560 \uc218 \uc788\uc73c\ubbc0\ub85c \ub2e4\uc591\ud55c \ucda9\ub3cc \ucc98\ub9ac \uc804\ub7b5\uc744 \uc801\uc6a9\ud560 \uc218 \uc788\ub2e4.")),(0,r.kt)("h3",{id:"\ub2e8\uc810"},"\ub2e8\uc810"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\ucda9\ub3cc \ucc98\ub9ac\uc758 \ubcf5\uc7a1\uc131 : \ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud588\uc744 \ub54c \uc774\ub97c \ucc98\ub9ac\ud558\uae30 \uc704\ud55c \ucd94\uac00 \ub85c\uc9c1\uc774 \ud544\uc694\ud558\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ucda9\ub3cc\uc774 \uc7a6\uc740 \ud658\uacbd\uc5d0\uc11c\uc758 \uc131\ub2a5 \uc800\ud558 : \ub370\uc774\ud130 \ucda9\ub3cc\uc774 \uc790\uc8fc \ubc1c\uc0dd\ud558\ub294 \ud658\uacbd\uc5d0\uc11c\ub294 \ub099\uad00\uc801 \ub77d\uc758 \uc774\uc810\uc774 \uac10\uc18c\ud560 \uc218 \uc788\ub2e4. \ucda9\ub3cc\uc774 \uc790\uc8fc \ubc1c\uc0dd\ud558\uba74 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc790\uc8fc \ub864\ubc31\ub418\uac70\ub098 \uc7ac\uc2dc\ub3c4\ub418\uae30 \ub54c\ubb38\uc5d0 \uc131\ub2a5 \uc800\ud558\uac00 \ubc1c\uc0dd\ud560 \uc218 \uc788\ub2e4.")),(0,r.kt)("h3",{id:"test-with-typeorm"},"Test With TypeORM"),(0,r.kt)("p",null,"\ud14c\uc2a4\ud2b8\uc5d0 \uc0ac\uc6a9\ub41c Coupon \uc5d4\ud2f0\ud2f0\uc5d0 ",(0,r.kt)("inlineCode",{parentName:"p"},"@VersionCoulumn")," \ub370\ucf54\ub808\uc774\ud130\ub97c \ud1b5\ud574 \uc5c5\ub370\uc774\ud2b8\uac00 \ud638\ucd9c\ub420 \ub54c\ub9c8\ub2e4 \uc790\ub3d9\uc73c\ub85c \uac12\uc744 \uc99d\ubd84\uc2dc\ucf1c\uc8fc\ub294 version \uce7c\ub7fc\uc744 \uc0ac\uc6a9\ud558\uc600\ub2e4."),(0,r.kt)(u.Z,{mdxType:"Tabs"},(0,r.kt)(a.Z,{value:"coupon.service.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"  async assignCouponWithOptimisticLock(userId: number): Promise<{\n    readCoupon?: Coupon;\n    saveCoupon?: Coupon;\n    error?: string;\n  }> {\n    const coupon = await this.couponRepository.findOne({\n      where: { isRedeemed: false },\n      order: { id: 'ASC' },\n    });\n\n    if (!coupon) {\n      throw new Error('No available coupons');\n    }\n\n    const updateResult = await this.couponRepository.update(\n      { id: coupon.id, version: coupon.version },\n      { isRedeemed: true, userId },\n    );\n\n    if (updateResult.affected === 0) {\n      return {\n        readCoupon: coupon,\n        error: 'Optimistic lock version mismatch',\n      };\n    }\n\n    return {\n      readCoupon: coupon,\n      saveCoupon: await this.couponRepository.findOne({\n        where: { id: coupon.id },\n      }),\n    };\n  }\n"))),(0,r.kt)(a.Z,{value:"coupon.lock.spec.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"}," it('should handle concurrent requests with optimistic lock', async () => {\n   const user1 = await userRepository.save({ name: 'user1' });\n   const user2 = await userRepository.save({ name: 'user2' });\n   const coupon = await couponRepository.save({\n     code: 'OPTIMISTIC_LOCK_COUPON',\n   });\n   const expectedVersion = coupon.version + 1;\n\n   const result1Promise = service.assignCouponWithOptimisticLock(user1.id);\n   const result2Promise = service.assignCouponWithOptimisticLock(user2.id);\n\n   const [result1, result2] = await Promise.all([\n     result1Promise,\n     result2Promise,\n   ]);\n\n   if (result1.saveCoupon) {\n     expect(result1.readCoupon.code).toBe('OPTIMISTIC_LOCK_COUPON');\n     expect(result1.readCoupon.version).toBe(coupon.version);\n     expect(result1.saveCoupon.code).toBe('OPTIMISTIC_LOCK_COUPON');\n     expect(result1.saveCoupon.userId).toBe(user1.id);\n     expect(result1.saveCoupon.version).toBe(expectedVersion);\n     expect(result2.error).toBe(`Optimistic lock version mismatch`);\n   } else {\n     expect(result2.readCoupon.code).toBe('OPTIMISTIC_LOCK_COUPON');\n     expect(result2.readCoupon.version).toBe(coupon.version);\n     expect(result2.saveCoupon.code).toBe('OPTIMISTIC_LOCK_COUPON');\n     expect(result2.saveCoupon.userId).toBe(user1.id);\n     expect(result2.saveCoupon.version).toBe(expectedVersion);\n     expect(result1.error).toBe(`Optimistic lock version mismatch`);\n   }\n")))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ud750\ub984"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"\ub450 \uc694\uccad(Promise) \ubaa8\ub450 \ubc84\uc804 \uac12\uc774 \uac19\uc740, \ub3d9\uc77c\ud55c ID\uc758 \ucfe0\ud3f0 \ub808\ucf54\ub4dc\ub97c \uc870\ud68c\ud55c\ub2e4. \ub808\ucf54\ub4dc \uc0dd\uc131 \ud6c4 \uc5c5\ub370\uc774\ud2b8\ud55c \uc801\uc774 \uc5c6\uae30 \ub54c\ubb38\uc5d0 version \uac12\uc740 1\uc774\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"update \ucffc\ub9ac\uc758 where \uc870\uac74\uc73c\ub85c version 1\uc774 \ub4e4\uc5b4\uac00\ubbc0\ub85c, \ub450 \uc694\uccad \uc911\uc5d0 \uba3c\uc800 \uc2e4\ud589\ub41c update \ucffc\ub9ac\ub9cc \ub808\ucf54\ub4dc\ub97c \uc218\uc815\ud55c\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\uc774\ubbf8 update\uac00 \uc2e4\ud589\ub418\uc5b4 version\uc774 2\ub85c \uc99d\uac00\ud55c \uacbd\uc6b0, \ub4a4\uc774\uc5b4 \uc2e4\ud589\ub41c update \ucffc\ub9ac\uc5d0\uc11c\ub294 where \uc870\uac74\uc758 version 1\ub85c \uc870\ud68c\ub418\ub294 \ucfe0\ud3f0\uc774 \uc5c6\uae30 \ub54c\ubb38\uc5d0 \ucfe0\ud3f0\uc774 \uc5c5\ub370\uc774\ud2b8 \ub418\uc9c0 \uc54a\ub294\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"update \ucffc\ub9ac \uacb0\uacfc\uc758 affected(\uc601\ud5a5\uc744 \ubc1b\uc740 \ub808\ucf54\ub4dc\uc758 \uc218)\uac00 0\uc778 \uacbd\uc6b0 \ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud55c \uc0c1\ud669\uc774\ubbc0\ub85c \uadf8\uc5d0 \ub530\ub978 \uc608\uc678\ucc98\ub9ac\ub97c \ud55c\ub2e4."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ucffc\ub9ac"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"}," -- \uc694\uccad 1,2\uc758 \uc870\ud68c \ucffc\ub9ac \uc2e4\ud589 (findOne)\n SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE ((`Coupon`.`isRedeemed` = ?)) ORDER BY `Coupon`.`id` ASC LIMIT 1\n SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE ((`Coupon`.`isRedeemed` = ?)) ORDER BY `Coupon`.`id` ASC LIMIT 1\n -- \uc694\uccad 1\uc758 \uc5c5\ub370\uc774\ud2b8 \ucffc\ub9ac\uac00 \uba3c\uc800 \uc2e4\ud589 \ub428 (update)\n UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE (`id` = ? AND `version` = ?) -- PARAMETERS: [1,9,5,1]\n -- \uc774 \ub54c\ub294 coupon\uc758 \ubc84\uc804\uc774 2\ub85c \uc5c5\ub370\uc774\ud2b8 \ub41c \uc774\ud6c4\uc774\ubbc0\ub85c \ub808\ucf54\ub4dc \uc218\uc815\uc774 \uc774\ub8e8\uc5b4\uc9c0\uc9c0 \uc54a\uc74c (update)\n UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE (`id` = ? AND `version` = ?) -- PARAMETERS: [1,10,5,1]\n")))),(0,r.kt)("p",null,"\uc704 \ud14c\uc2a4\ud2b8\uc5d0\uc11c\ub294 \uc11c\ube44\uc2a4 \ud568\uc218 \ub0b4\uc5d0\uc11c \uc774\ub8e8\uc5b4\uc9c0\ub294 DB \uc791\uc5c5\ub4e4\uc744 \ud2b8\ub79c\uc7ad\uc158\uc73c\ub85c \ubb36\uc9c0 \uc54a\uc558\uc9c0\ub9cc, \uc5ec\ub7ec \uc5d4\ud2f0\ud2f0\uc5d0 \ub300\ud55c \uc77d\uae30/\uc4f0\uae30 \uc791\uc5c5\uc774 \uc77c\uad00\uc131 \uc788\uac8c \uc774\ub8e8\uc5b4\uc838\uc57c \ud558\ub294 \ubcf5\uc7a1\ud55c \uc0c1\ud669\uc5d0\uc11c\ub294 \ud2b8\ub79c\uc7ad\uc158\uc744 \uc0ac\uc6a9\ud558\uc5ec \ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud55c \uacbd\uc6b0 \ub864\ubc31\uc744 \ud558\ub294 \uc2dd\uc73c\ub85c \ucc98\ub9ac\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("h2",{id:"\ube44\uad00\uc801-\ub77d-pessimistic-lock"},"\ube44\uad00\uc801 \ub77d (Pessimistic Lock)"),(0,r.kt)("p",null,"\ube44\uad00\uc801 \ub77d(Pessimistic Lock)\uc740 \ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud55c\ub2e4\uace0 \uac00\uc815\ud558\uace0, \uc6b0\uc120 Lock\uc744 \uac70\ub294 \ubc29\ubc95\uc774\ub2e4. \ub099\uad00\uc801 \ub77d\uacfc \ub2ec\ub9ac DB \ucc28\uc6d0\uc758 \ub77d \uae30\ub2a5\uc744 \ud65c\uc6a9\ud55c\ub2e4. \ub77d\uc744 \ud68d\ub4dd\ud560 \ub54c\uae4c\uc9c0 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc740 \ub300\uae30\ud558\uac8c \ub41c\ub2e4. \ube44\uad00\uc801 \ub77d\uc5d0\ub294 \uc77d\uae30 \ub77d(\uacf5\uc720 \ub77d)\uacfc \uc4f0\uae30 \ub77d(\ubc30\ud0c0 \ub77d)\uc774 \uc788\ub2e4."),(0,r.kt)("h3",{id:"\ube44\uad00\uc801-\ub77d-vs-\ub099\uad00\uc801-\ub77d"},"\ube44\uad00\uc801 \ub77d vs \ub099\uad00\uc801 \ub77d"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\ube44\uad50 \ud56d\ubaa9")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\ube44\uad00\uc801 \ub77d (Pessimistic Lock)")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\ub099\uad00\uc801 \ub77d (Optimistic Lock)")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"\uc131\ub2a5")),(0,r.kt)("td",{parentName:"tr",align:null},"\uc790\uc6d0 \uc7a0\uae08 \uad00\ub9ac\ub85c \uc778\ud574 \uc624\ubc84\ud5e4\ub4dc\uac00 \ubc1c\uc0dd\ud558\uc5ec \uc131\ub2a5\uc774 \uc800\ud558\ub420 \uc218 \uc788\uc74c"),(0,r.kt)("td",{parentName:"tr",align:null},"\ub77d \uad00\ub9ac \uc624\ubc84\ud5e4\ub4dc\uac00 \uc5c6\uc73c\ub098, \ucda9\ub3cc\uc774 \uc7a6\uc744 \uacbd\uc6b0 \ub864\ubc31\uc774 \ub9ce\uc544\uc838 \uc131\ub2a5\uc774 \uc800\ud558\ub420 \uc218 \uc788\uc74c")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"\ub370\uc774\ud130 \uc815\ud569\uc131")),(0,r.kt)("td",{parentName:"tr",align:null},"\ud2b8\ub79c\uc7ad\uc158 \uc911 \uc790\uc6d0\uc744 \uc7a0\uadf8\ubbc0\ub85c, \ub370\uc774\ud130 \uc815\ud569\uc131\uc774 \ub192\uc740 \uc218\uc900\uc73c\ub85c \uc720\uc9c0\ub428"),(0,r.kt)("td",{parentName:"tr",align:null},"\ucda9\ub3cc\uc774 \ubc1c\uc0dd\ud560 \uacbd\uc6b0 \ub370\uc774\ud130 \uc815\ud569\uc131 \uc720\uc9c0\uac00 \uc5b4\ub824\uc6b8 \uc218 \uc788\uc74c")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"\uc0ac\uc6a9 \uc0ac\ub840")),(0,r.kt)("td",{parentName:"tr",align:null},"\ub3d9\uc2dc \uc811\uadfc\uc774 \ube48\ubc88\ud558\uace0 \ub370\uc774\ud130 \ubb34\uacb0\uc131\uc774 \uc911\uc694\ud55c \ud658\uacbd"),(0,r.kt)("td",{parentName:"tr",align:null},"\ub370\uc774\ud130 \ucda9\ub3cc \uac00\ub2a5\uc131\uc774 \ub0ae\uace0 \uc131\ub2a5\uc774 \uc911\uc694\ud55c \ud658\uacbd")))),(0,r.kt)("h2",{id:"\uc77d\uae30-\ub77d-read-lock--\uacf5\uc720-\ub77d-shared-lock"},"\uc77d\uae30 \ub77d (Read Lock) & \uacf5\uc720 \ub77d (Shared Lock)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\uacf5\uc720 \ub77d\uc740 \ud558\ub098\uc758 \ud2b8\ub79c\uc7ad\uc158\uc774 \ub370\uc774\ud130\ub97c \uc77d\ub294 \ub3d9\uc548 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc774 \ud574\ub2f9 \ub370\uc774\ud130\ub97c \uc77d\uc744 \uc218 \uc788\ub3c4\ub85d \ud5c8\uc6a9\ud558\uc9c0\ub9cc, \ub370\uc774\ud130\ub97c \uc218\uc815\ud558\ub294 \uac83\uc740 \ub9c9\ub294 \ub77d\uc774\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\uacf5\uc720 \ub77d\uc774 \uac78\ub9b0 \ub370\uc774\ud130\uc5d0 \ub300\ud574\uc11c \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\ub3c4 \uacf5\uc720 \ub77d\uc744 \ud68d\ub4dd\ud560 \uc218 \uc788\uc73c\ub098 \ubc30\ud0c0 \ub77d\uc740 \ud68d\ub4dd\ud560 \uc218 \uc5c6\ub2e4. \uc5ec\ub7ec \ud2b8\ub79c\uc7ad\uc158\uc774 \ub3d9\uc77c\ud55c \uc790\uc6d0\uc5d0 \ub300\ud574 \uacf5\uc720 \ub77d\uc744 \ud68d\ub4dd\ud560 \uc218 \uc788\uc73c\ubbc0\ub85c \uc77d\uae30 \uc791\uc5c5 \uac04\uc758 \ub3d9\uc2dc\uc131\uc744 \ub192\uc5ec\uc900\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\uacf5\uc720 \ub77d\uc744 \uc0ac\uc6a9\ud558\uba74 \uc870\ud68c\ud55c \ub370\uc774\ud130\uac00 \ud2b8\ub79c\uc7ad\uc158 \ub0b4\ub0b4 \ubcc0\uacbd\ub418\uc9c0 \uc54a\uc74c\uc744 \ubcf4\uc7a5\ud55c\ub2e4.")),(0,r.kt)("h3",{id:"\uc7a5\uc810-1"},"\uc7a5\uc810"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\ub3d9\uc2dc\uc131 \uc99d\uac00 : \uc5ec\ub7ec \ud2b8\ub79c\uc7ad\uc158\uc774 \ub3d9\uc2dc\uc5d0 \ub3d9\uc77c\ud55c \ub370\uc774\ud130\uc5d0 \ub300\ud55c \uc77d\uae30 \uc791\uc5c5\uc744 \uc218\ud589\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ub370\uc774\ud130 \uc77c\uad00\uc131 \uc720\uc9c0 : \uacf5\uc720 \ub77d\uc744 \ud1b5\ud574 \ub370\uc774\ud130\ub97c \uc77d\ub294 \ub3d9\uc548 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc774 \ud574\ub2f9 \ub370\uc774\ud130\ub97c \uc218\uc815\ud558\uc9c0 \ubabb\ud558\ub3c4\ub85d \ub9c9\uae30 \ub54c\ubb38\uc5d0, \ub370\uc774\ud130\uc758 \uc77c\uad00\uc131\uc774 \uc720\uc9c0\ub41c\ub2e4.")),(0,r.kt)("h3",{id:"\ub2e8\uc810-1"},"\ub2e8\uc810"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\uc4f0\uae30 \uc791\uc5c5\uc758 \uc9c0\uc5f0 : \uacf5\uc720 \ub77d\uc774 \uac78\ub9b0 \ub370\uc774\ud130\uc5d0 \ub300\ud574 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc774 \ubc30\ud0c0 \ub77d\uc744 \uac78\uc5b4 \ub370\uc774\ud130\ub97c \uc218\uc815\ud558\ub824\uace0 \ud560 \ub54c, \uacf5\uc720 \ub77d\uc774 \ud574\uc81c\ub420 \ub54c\uae4c\uc9c0 \ub300\uae30\ud574\uc57c \ud558\ubbc0\ub85c \uc4f0\uae30 \uc791\uc5c5\uc758 \uc9c0\uc5f0\uc744 \ucd08\ub798\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ub370\ub4dc\ub77d \uac00\ub2a5\uc131 : \uacf5\uc720 \ub77d\uacfc \ubc30\ud0c0 \ub77d\uc774 \uc11c\ub85c \ucda9\ub3cc\ud558\ub294 \uc0c1\ud669\uc774 \ubc1c\uc0dd\ud560 \uc218 \uc788\ub2e4. \uc608\ub97c \ub4e4\uc5b4, \ub450 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc11c\ub85c \ub2e4\ub978 \uc790\uc6d0\uc5d0 \ub300\ud574 \uacf5\uc720 \ub77d\uc744 \ud68d\ub4dd\ud55c \uc0c1\ud0dc\uc5d0\uc11c \uc0c1\ub300\ubc29\uc774 \uac00\uc9c4 \uc790\uc6d0\uc5d0 \ub300\ud574 \ubc30\ud0c0 \ub77d\uc744 \uc694\uad6c\ud560 \uacbd\uc6b0, \ub370\ub4dc\ub77d\uc774 \ubc1c\uc0dd\ud560 \uc218 \uc788\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ub77d \uc720\uc9c0 \ube44\uc6a9 : \uc5ec\ub7ec \ud2b8\ub79c\uc7ad\uc158\uc774 \uacf5\uc720 \ub77d\uc744 \uac78 \uc218 \uc788\uc73c\ubbc0\ub85c, \uc2dc\uc2a4\ud15c\uc740 \ub354 \ub9ce\uc740 \ub77d\uc744 \uad00\ub9ac\ud574\uc57c \ud55c\ub2e4. \uc774\ub294 \ub77d\uc744 \uc720\uc9c0\ud558\uace0 \uad00\ub9ac\ud558\ub294 \uc624\ubc84\ud5e4\ub4dc\ub97c \uc99d\uac00\uc2dc\ud0ac \uc218 \uc788\ub2e4.")),(0,r.kt)("h3",{id:"test-with-typeorm-1"},"Test With TypeORM"),(0,r.kt)(u.Z,{mdxType:"Tabs"},(0,r.kt)(a.Z,{value:"coupon.service.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"  async assignCouponWithPessimisticReadLock(userId: number): Promise<{\n    readCoupon?: Coupon;\n    saveCoupon?: Coupon;\n    error?: string;\n  }> {\n    const queryRunner = this.dataSource.createQueryRunner();\n    await queryRunner.startTransaction();\n\n    let coupon;\n    let saveCoupon;\n    let error;\n\n    try {\n      coupon = await queryRunner.manager\n        .createQueryBuilder(Coupon, 'coupon')\n        .where('coupon.isRedeemed = :isRedeemed', { isRedeemed: false })\n        .setLock('pessimistic_read')\n        .orderBy('coupon.id', 'ASC')\n        .getOne();\n\n      if (!coupon) {\n        throw new Error('No available coupons');\n      }\n\n      coupon.isRedeemed = true;\n      coupon.userId = userId;\n\n      saveCoupon = await queryRunner.manager.save(coupon);\n\n      await queryRunner.commitTransaction();\n    } catch (e) {\n      await queryRunner.rollbackTransaction();\n      error = e.message;\n    } finally {\n      await queryRunner.release();\n\n      return {\n        readCoupon: coupon,\n        saveCoupon,\n        error,\n      };\n    }\n  }\n"))),(0,r.kt)(a.Z,{value:"coupon.lock.spec.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'it("should handle concurrent requests with pessimistic read lock", async () => {\n  const user1 = await userRepository.save({ name: "user1" });\n  const user2 = await userRepository.save({ name: "user2" });\n  await couponRepository.save({ code: "PESSIMISTIC_READ_LOCK_COUPON" });\n\n  const result1Promise = service.assignCouponWithPessimisticReadLock(user1.id);\n  const result2Promise = service.assignCouponWithPessimisticReadLock(user2.id);\n\n  const [result1, result2] = await Promise.all([\n    result1Promise,\n    result2Promise,\n  ]);\n\n  // \ucfe0\ud3f0 \uc77d\uae30\ub294 \uac00\ub2a5\ud558\uc9c0\ub9cc \uc4f0\uae30\ub294 \ubd88\uac00\ud558\ubbc0\ub85c \ud558\ub098\uc758 \ucfe0\ud3f0\ub9cc \uc5c5\ub370\uc774\ud2b8 \ub428\n  expect(result1.readCoupon.code).toBe("PESSIMISTIC_READ_LOCK_COUPON");\n  expect(result2.readCoupon.code).toBe("PESSIMISTIC_READ_LOCK_COUPON");\n  if (result1.saveCoupon) {\n    expect(result1.saveCoupon.code).toBe("PESSIMISTIC_READ_LOCK_COUPON");\n    expect(result1.saveCoupon.userId).toBe(user1.id);\n    expect(result2.saveCoupon).toBeUndefined();\n    expect(result2.error).toBe(\n      "Deadlock found when trying to get lock; try restarting transaction",\n    );\n  } else {\n    expect(result2.saveCoupon.code).toBe("PESSIMISTIC_READ_LOCK_COUPON");\n    expect(result2.saveCoupon.userId).toBe(user2.id);\n    expect(result1.saveCoupon).toBeUndefined();\n    expect(result1.error).toBe(\n      "Deadlock found when trying to get lock; try restarting transaction",\n    );\n  }\n});\n')))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ud750\ub984"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"\uacf5\uc720 \ub77d\uc740 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc758 \uacf5\uc720 \ub77d\uc744 \ud5c8\uc6a9\ud558\uae30 \ub54c\ubb38\uc5d0 \ub450 \uc694\uccad \ubaa8\ub450 \ucfe0\ud3f0 \uc870\ud68c\uac00 \uac00\ub2a5\ud558\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\uc5c5\ub370\uc774\ud2b8\ub97c \uc704\ud574 \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud558\ub824\ud558\uc9c0\ub9cc, \ub450 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ubaa8\ub450 \uacf5\uc720 \ub77d\uc774 \uac78\ub824\uc788\uae30 \ub54c\ubb38\uc5d0 \uc11c\ub85c\uc758 \ub77d\uc774 \ud574\uc81c\ub418\uae30\ub97c \uae30\ub2e4\ub9ac\ub294 \ub370\ub4dc\ub77d\uc774 \ubc1c\uc0dd\ud55c\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\ub370\ub4dc\ub77d \uc0c1\ud669\uc744 \ud574\uacb0\ud558\uae30 \uc704\ud574 \ud558\ub098\uc758 \ud2b8\ub79c\uc7ad\uc158\uc744 \ub864\ubc31 \ucc98\ub9ac\ub418\uace0, \ub0a8\uc740 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc5c5\ub370\uc774\ud2b8 \ubc0f \ucee4\ubc0b\uc5d0 \uc131\uacf5\ud55c\ub2e4."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ucffc\ub9ac"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"  -- \uccab \ubc88\uc9f8 \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \ub450 \ubc88\uc9f8 \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\uba70 \uacf5\uc720 \ub77d \uc124\uc815 (getOne)\n  SELECT `coupon`.`id` AS `coupon_id`, `coupon`.`code` AS `coupon_code`, `coupon`.`isRedeemed` AS `coupon_isRedeemed`, `coupon`.`user_id` AS `coupon_user_id`, `coupon`.`version` AS `coupon_version` FROM `coupon` `coupon` WHERE `coupon`.`isRedeemed` = ? ORDER BY `coupon`.`id` ASC FOR SHARE -- PARAMETERS: [false]\n  -- \ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\ub3c4 \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\uba70 \uacf5\uc720 \ub77d \uc124\uc815 (getOne)\n  SELECT `coupon`.`id` AS `coupon_id`, `coupon`.`code` AS `coupon_code`, `coupon`.`isRedeemed` AS `coupon_isRedeemed`, `coupon`.`user_id` AS `coupon_user_id`, `coupon`.`version` AS `coupon_version` FROM `coupon` `coupon` WHERE `coupon`.`isRedeemed` = ? ORDER BY `coupon`.`id` ASC FOR SHARE -- PARAMETERS: [false]\n  -- \uc694\uccad 1,2\uc758 \uc870\ud68c \ucffc\ub9ac (save)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` IN (?) -- PARAMETERS: [2]\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` IN (?) -- PARAMETERS: [2]\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0 \uc5c5\ub370\uc774\ud2b8 (save), \uc5c5\ub370\uc774\ud2b8\ub97c \uc704\ud574\uc11c\ub294 \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud574\uc57c\ud558\uc9c0\ub9cc \ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c\ub3c4 \uacf5\uc720 \ub77d\uc774 \uac78\ub824\uc788\uae30 \ub54c\ubb38\uc5d0 \ud68d\ub4dd \ubd88\uac00\n  UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE `id` IN (?) -- PARAMETERS: [1,3,2]\n  -- \ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0 \uc5c5\ub370\uc774\ud2b8 (save), \uc5c5\ub370\uc774\ud2b8\ub97c \uc704\ud574\uc11c\ub294 \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud574\uc57c\ud558\uc9c0\ub9cc \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \uacf5\uc720 \ub77d\uc774 \uac78\ub824\uc788\uae30 \ub54c\ubb38\uc5d0 \ud68d\ub4dd \ubd88\uac00\n  UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE `id` IN (?) -- PARAMETERS: [1,4,2]\n  -- \ub450 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \uc11c\ub85c \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud558\uae30 \uc704\ud574 \ubb34\ud55c\ub300\uae30\ud558\uac8c \ub418\ubbc0\ub85c \ub370\ub4dc\ub77d \ubc1c\uc0dd \ud6c4 \ud558\ub098\uc758 \ud2b8\ub79c\uc7ad\uc158 \ub864\ubc31 \ucc98\ub9ac\n  ROLLBACK\n  -- \ub370\ub4dc\ub77d \ud574\uc18c \ud6c4 \ub0a8\uc740 \ud2b8\ub79c\uc7ad\uc158 \uc870\ud68c \ucffc\ub9ac (save)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` = ? -- PARAMETERS: [2]\n  -- \ub370\ub4dc\ub77d \ud574\uc18c \ud6c4 \ub0a8\uc740 \ud2b8\ub79c\uc7ad\uc158 \ucee4\ubc0b\n  COMMIT\n")))),(0,r.kt)("h2",{id:"\uc4f0\uae30-\ub77d-write-lock--\ubc30\ud0c0-\ub77d-exclusive-lock"},"\uc4f0\uae30 \ub77d (Write Lock) & \ubc30\ud0c0 \ub77d (Exclusive Lock)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\ubc30\ud0c0 \ub77d\uc740 \uc790\uc6d0\uc5d0 \ub300\ud55c \uc811\uadfc\uc744 \ub3c5\uc810\ud558\uba70, \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc5d0 \ud574\ub2f9 \uc790\uc6d0\uc5d0 \ub300\ud574 \uc77d\uae30\ub098 \uc4f0\uae30 \uc791\uc5c5\uc744 \ud560 \uc218 \uc5c6\ub3c4\ub85d \ucc28\ub2e8\ud55c\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ubc30\ud0c0 \ub77d\uc5d0 \uac78\ub9b0 \uc790\uc6d0\uc740 \ud574\ub2f9 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc644\ub8cc\ub420 \ub54c\uae4c\uc9c0 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc811\uadfc\ud558\uc9c0 \ubabb\ud55c\ub2e4. \uc989, \ubc30\ud0c0 \ub77d\uc774 \uac78\ub9b0 \ub3d9\uc548 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc740 \ud574\ub2f9 \uc790\uc6d0\uc5d0 \ub300\ud574 \uc5b4\ub5a4 \uc791\uc5c5\ub3c4 \uc218\ud589\ud560 \uc218 \uc5c6\ub2e4.")),(0,r.kt)("h3",{id:"\uc7a5\uc810-2"},"\uc7a5\uc810"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\ub370\uc774\ud130 \uc77c\uad00\uc131 \ubcf4\uc7a5 : \ubc30\ud0c0 \ub77d\uc740 \ud2b8\ub79c\uc7ad\uc158 \uac04\uc758 \uacbd\uc7c1 \uc870\uac74\uc744 \ubc29\uc9c0\ud558\uc5ec \ub370\uc774\ud130\uc758 \ubb34\uacb0\uc131\uacfc \uc77c\uad00\uc131\uc744 \uc720\uc9c0\ud55c\ub2e4. \uc5ec\ub7ec \ud2b8\ub79c\uc7ad\uc158\uc774 \ub3d9\uc2dc\uc5d0 \ub3d9\uc77c\ud55c \ub370\uc774\ud130\ub97c \uc218\uc815\ud558\ub824\uace0 \ud560 \ub54c \ubc1c\uc0dd\ud560 \uc218 \uc788\ub294 \ucda9\ub3cc\uc744 \ubc29\uc9c0\ud55c\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\uc548\uc804\ud55c \uc4f0\uae30 \uc791\uc5c5 : \uc4f0\uae30 \uc791\uc5c5 \uc911 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc758 \uac04\uc12d\uc744 \ubc29\uc9c0\ud558\uc5ec \uc548\uc815\uc801\uc73c\ub85c \ub370\uc774\ud130\ub97c \uc218\uc815\ud560 \uc218 \uc788\ub2e4. \uc774\ub294 \ud2b9\ud788 \uc911\uc694\ud55c \uae08\uc735 \uac70\ub798\ub098 \uc7ac\uace0 \uad00\ub9ac\uc640 \uac19\uc740 \uc0c1\ud669\uc5d0\uc11c \uc720\uc6a9\ud558\ub2e4.")),(0,r.kt)("h3",{id:"\ub2e8\uc810-2"},"\ub2e8\uc810"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\ub3d9\uc2dc\uc131 \uc800\ud558 : \ubc30\ud0c0 \ub77d\uc774 \uac78\ub9b0 \ub370\uc774\ud130\ub294 \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc811\uadfc\ud560 \uc218 \uc5c6\uae30 \ub54c\ubb38\uc5d0 \uc2dc\uc2a4\ud15c\uc758 \ub3d9\uc2dc \ucc98\ub9ac \ub2a5\ub825\uc774 \uc800\ud558\ub420 \uc218 \uc788\ub2e4. \ub9ce\uc740 \ud2b8\ub79c\uc7ad\uc158\uc774 \ub3d9\uc77c\ud55c \ub370\uc774\ud130\ub97c \ub2e4\ub8e8\ub824\uace0 \ud560 \uacbd\uc6b0, \ub300\uae30 \uc2dc\uac04\uc774 \ub298\uc5b4\ub098\uba74\uc11c \uc804\uccb4 \uc2dc\uc2a4\ud15c \uc131\ub2a5\uc774 \uc800\ud558\ub420 \uc218 \uc788\ub2e4."),(0,r.kt)("li",{parentName:"ul"},"\ub370\ub4dc\ub77d \uac00\ub2a5\uc131 : \uc5ec\ub7ec \ud2b8\ub79c\uc7ad\uc158\uc774 \uc11c\ub85c \ub2e4\ub978 \ub9ac\uc18c\uc2a4\uc5d0 \ub300\ud574 \ubc30\ud0c0 \ub77d\uc744 \uac78\ub824\uace0 \ud560 \ub54c, \uac01 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc0c1\ub300\ubc29\uc758 \ub77d \ud574\uc81c\ub97c \uae30\ub2e4\ub9ac\uba74\uc11c \uad50\ucc29 \uc0c1\ud0dc\uc5d0 \ube60\uc9c8 \uc218 \uc788\ub2e4.")),(0,r.kt)("h3",{id:"test-with-typeorm-2"},"Test With TypeORM"),(0,r.kt)(u.Z,{mdxType:"Tabs"},(0,r.kt)(a.Z,{value:"coupon.service.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"async assignCouponWithPessimisticWriteLock(userId: number): Promise<{\n    readCoupon?: Coupon;\n    saveCoupon?: Coupon;\n    error?: string;\n  }> {\n    const queryRunner = this.dataSource.createQueryRunner();\n    await queryRunner.startTransaction();\n\n    let coupon;\n    let saveCoupon;\n    let error;\n\n    try {\n      coupon = await queryRunner.manager\n        .createQueryBuilder(Coupon, 'coupon')\n        .where('coupon.isRedeemed = :isRedeemed', { isRedeemed: false })\n        .setLock('pessimistic_write')\n        .orderBy('coupon.id', 'ASC')\n        .getOne();\n\n      if (!coupon) {\n        throw new Error('No available coupon');\n      }\n\n      coupon.isRedeemed = true;\n      coupon.userId = userId;\n\n      saveCoupon = await queryRunner.manager.save(coupon);\n\n      await queryRunner.commitTransaction();\n    } catch (e) {\n      await queryRunner.rollbackTransaction();\n      error = e.message;\n    } finally {\n      await queryRunner.release();\n\n      return {\n        readCoupon: coupon,\n        saveCoupon,\n        error,\n      };\n    }\n  }\n"))),(0,r.kt)(a.Z,{value:"coupon.lock.spec.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'it("should handle concurrent requests with pessimistic wite lock", async () => {\n  const user1 = await userRepository.save({ name: "user1" });\n  const user2 = await userRepository.save({ name: "user2" });\n  await couponRepository.save({\n    code: "PESSIMISTIC_WRITE_LOCK_COUPON",\n  });\n\n  const result1Promise = service.assignCouponWithPessimisticWriteLock(user1.id);\n  const result2Promise = service.assignCouponWithPessimisticWriteLock(user2.id);\n\n  const [result1, result2] = await Promise.all([\n    result1Promise,\n    result2Promise,\n  ]);\n\n  // \ucfe0\ud3f0 \uc77d\uae30\ub3c4 \ubd88\uac00\n  if (result1.saveCoupon) {\n    expect(result1.readCoupon.code).toBe("PESSIMISTIC_WRITE_LOCK_COUPON");\n    expect(result1.saveCoupon.code).toBe("PESSIMISTIC_WRITE_LOCK_COUPON");\n    expect(result1.saveCoupon.userId).toBe(user1.id);\n\n    expect(result2.readCoupon).toBeNull();\n    expect(result2.saveCoupon).toBeUndefined();\n    expect(result2.error).toBe("No available coupon");\n  } else {\n    expect(result2.readCoupon.code).toBe("PESSIMISTIC_WRITE_LOCK_COUPON");\n    expect(result2.saveCoupon.code).toBe("PESSIMISTIC_WRITE_LOCK_COUPON");\n    expect(result2.saveCoupon.userId).toBe(user2.id);\n    expect(result1.readCoupon).toBeNull();\n    expect(result1.saveCoupon).toBeUndefined();\n    expect(result1.error).toBe("No available coupon");\n  }\n});\n')))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ud750\ub984"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"\uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc774 \ucfe0\ud3f0\uc744 \uc870\ud68c\ud568\uacfc \ub3d9\uc2dc\uc5d0 \ucfe0\ud3f0\uc5d0 \ub300\ud55c \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud55c\ub2e4. \ubc30\ud0c0 \ub77d\uc73c\ub85c \uc778\ud574, \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc774 \ub3d9\uc77c\ud55c \ucfe0\ud3f0\uc5d0 \uc811\uadfc\ud558\uac70\ub098 \uc218\uc815\ud560 \uc218 \uc5c6\uac8c \ub41c\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\ub3c4 \ub3d9\uc77c\ud55c \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\ub824\uace0 \uc2dc\ub3c4\ud558\uc9c0\ub9cc, \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc774\ubbf8 \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud55c \uc0c1\ud0dc\uc774\ubbc0\ub85c \ub300\uae30 \uc0c1\ud0dc\uc5d0 \ub4e4\uc5b4\uac04\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0 \uc5c5\ub370\uc774\ud2b8\uac00 \uc644\ub8cc\ub41c \ud6c4 \ud2b8\ub79c\uc7ad\uc158\uc774 \ucee4\ubc0b\ub418\uace0 \ub77d\uc774 \ud574\uc81c\ub41c\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc774 \ub2e4\uc2dc \uc2dc\ub3c4\ub418\uba70 \ucfe0\ud3f0\uc744 \uc870\ud68c\ud55c\ub2e4. \uadf8\ub7ec\ub098 \uc774 \uc2dc\uc810\uc5d0\uc11c \ucfe0\ud3f0\uc740 \uc774\ubbf8 \ud560\ub2f9\ub41c \uc0c1\ud0dc (",(0,r.kt)("inlineCode",{parentName:"li"},"isRedeemed"),"\uc774 true)\uc774\ubbc0\ub85c, \uc870\ud68c\ub41c \ucfe0\ud3f0\uc774 \uc5c6\uc5b4 \uc0ac\uc6a9\ud560 \uc218 \uc788\ub294 \ucfe0\ud3f0\uc774 \uc5c6\ub2e4\ub294 \uc624\ub958\ub97c \ubc18\ud658\ud558\uace0 \ub864\ubc31\ub41c\ub2e4."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ucffc\ub9ac"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"  -- \uccab \ubc88\uc9f8 \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \ub450 \ubc88\uc9f8 \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\uba70 \ubc30\ud0c0 \ub77d \ud68d\ub4dd (getOne)\n  SELECT `coupon`.`id` AS `coupon_id`, `coupon`.`code` AS `coupon_code`, `coupon`.`isRedeemed` AS `coupon_isRedeemed`, `coupon`.`user_id` AS `coupon_user_id`, `coupon`.`version` AS `coupon_version` FROM `coupon` `coupon` WHERE `coupon`.`isRedeemed` = ? ORDER BY `coupon`.`id` ASC FOR UPDATE -- PARAMETERS: [false]\n  -- \ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\uba70 \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud558\ub824\ud558\uc9c0\ub9cc \uc774\ubbf8 \ubc30\ud0c0 \ub77d\uc774 \uac78\ub824\uc788\uc73c\ubbc0\ub85c \ub300\uae30\n  SELECT `coupon`.`id` AS `coupon_id`, `coupon`.`code` AS `coupon_code`, `coupon`.`isRedeemed` AS `coupon_isRedeemed`, `coupon`.`user_id` AS `coupon_user_id`, `coupon`.`version` AS `coupon_version` FROM `coupon` `coupon` WHERE `coupon`.`isRedeemed` = ? ORDER BY `coupon`.`id` ASC FOR UPDATE -- PARAMETERS: [false]\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc758 \ucfe0\ud3f0 \uc5c5\ub370\uc774\ud2b8 \ubc0f \uc870\ud68c (save)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` IN (?) -- PARAMETERS: [3]\n  UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE `id` IN (?) -- PARAMETERS: [1,5,3]\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` = ? -- PARAMETERS: [3]\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158 \ucee4\ubc0b\n  COMMIT\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc758 \ub77d\uc774 \ud574\uc81c\ub418\uc5b4 \ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc2e4\ud589\ub418\uc9c0\ub9cc \uc870\ud68c\ub41c \ucfe0\ud3f0\uc774 \uc5c6\uae30 \ub54c\ubb38\uc5d0 \ub864\ubc31\n  ROLLBACK\n")))),(0,r.kt)("h4",{id:"nowait-\uc635\uc158-\uc124\uc815\uc2dc"},"NOWAIT \uc635\uc158 \uc124\uc815\uc2dc"),(0,r.kt)(u.Z,{mdxType:"Tabs"},(0,r.kt)(a.Z,{value:"coupon.service.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"  async assignCouponWithPessimisticWriteLockNoWait(userId: number): Promise<{\n    readCoupon?: Coupon;\n    saveCoupon?: Coupon;\n    error?: string;\n  }> {\n    const queryRunner = this.dataSource.createQueryRunner();\n    await queryRunner.startTransaction();\n\n    let coupon;\n    let saveCoupon;\n    let error;\n\n    try {\n      coupon = await queryRunner.manager\n        .createQueryBuilder(Coupon, 'coupon')\n        .where('coupon.isRedeemed = :isRedeemed', { isRedeemed: false })\n        .setLock('pessimistic_write')\n        .setOnLocked('nowait')\n        .orderBy('coupon.id', 'ASC')\n        .getOne();\n\n      if (!coupon) {\n        throw new Error('No available coupon');\n      }\n\n      coupon.isRedeemed = true;\n      coupon.userId = userId;\n\n      saveCoupon = await queryRunner.manager.save(coupon);\n\n      await queryRunner.commitTransaction();\n    } catch (e) {\n      await queryRunner.rollbackTransaction();\n      error = e.message;\n    } finally {\n      await queryRunner.release();\n\n      return {\n        readCoupon: coupon,\n        saveCoupon,\n        error,\n      };\n    }\n  }\n"))),(0,r.kt)(a.Z,{value:"coupon.lock.spec.ts",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'it("should handle concurrent requests with pessimistic wite lock : no wait", async () => {\n  const user1 = await userRepository.save({ name: "user1" });\n  const user2 = await userRepository.save({ name: "user2" });\n  await couponRepository.save({\n    code: "PESSIMISTIC_WRITE_LOCK_NO_WAIT_COUPON",\n  });\n\n  const result1Promise = service.assignCouponWithPessimisticWriteLockNoWait(\n    user1.id,\n  );\n  const result2Promise = service.assignCouponWithPessimisticWriteLockNoWait(\n    user2.id,\n  );\n\n  const [result1, result2] = await Promise.all([\n    result1Promise,\n    result2Promise,\n  ]);\n\n  // \ucfe0\ud3f0 \uc77d\uae30\ub3c4 \ubd88\uac00, \ub77d\uc774 \uac78\ub9b0 \ub370\uc774\ud130\ub97c \uc77d\uc73c\ub824\uace0 \ud560 \ub54c \ubc14\ub85c \uc5d0\ub7ec\n  if (result1.saveCoupon) {\n    expect(result1.readCoupon.code).toBe(\n      "PESSIMISTIC_WRITE_LOCK_NO_WAIT_COUPON",\n    );\n    expect(result1.saveCoupon.code).toBe(\n      "PESSIMISTIC_WRITE_LOCK_NO_WAIT_COUPON",\n    );\n    expect(result1.saveCoupon.userId).toBe(user1.id);\n\n    expect(result2.readCoupon).toBeUndefined();\n    expect(result2.saveCoupon).toBeUndefined();\n    expect(result2.error).toBe(\n      "Statement aborted because lock(s) could not be acquired immediately and NOWAIT is set.",\n    );\n  } else {\n    expect(result2.readCoupon.code).toBe(\n      "PESSIMISTIC_WRITE_LOCK_NO_WAIT_COUPON",\n    );\n    expect(result2.saveCoupon.code).toBe(\n      "PESSIMISTIC_WRITE_LOCK_NO_WAIT_COUPON",\n    );\n    expect(result2.saveCoupon.userId).toBe(user2.id);\n    expect(result1.readCoupon).toBeUndefined();\n    expect(result1.saveCoupon).toBeUndefined();\n    expect(result1.error).toBe(\n      "Statement aborted because lock(s) could not be acquired immediately and NOWAIT is set.",\n    );\n  }\n});\n')))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ud750\ub984"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"\uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc774 \ucfe0\ud3f0\uc744 \uc870\ud68c\ud568\uacfc \ub3d9\uc2dc\uc5d0 \ucfe0\ud3f0\uc5d0 \ub300\ud55c \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud55c\ub2e4. \ubc30\ud0c0 \ub77d\uc73c\ub85c \uc778\ud574, \ub2e4\ub978 \ud2b8\ub79c\uc7ad\uc158\uc774 \ub3d9\uc77c\ud55c \ucfe0\ud3f0\uc5d0 \uc811\uadfc\ud558\uac70\ub098 \uc218\uc815\ud560 \uc218 \uc5c6\uac8c \ub41c\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\ub3c4 \ub3d9\uc77c\ud55c \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\ub824\uace0 \uc2dc\ub3c4\ud558\uc9c0\ub9cc, \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc774 \uc774\ubbf8 \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud55c \uc0c1\ud0dc\uc774\uace0 ",(0,r.kt)("inlineCode",{parentName:"li"},"NOWAIT")," \uc635\uc158\uc774 \uc124\uc815\ub418\uc5b4 \uc788\uc73c\ubbc0\ub85c \uc989\uc2dc \uc624\ub958\uac00 \ubc1c\uc0dd\ud558\uace0 \ud2b8\ub79c\uc7ad\uc158\uc774 \ub864\ubc31\ub41c\ub2e4."),(0,r.kt)("li",{parentName:"ol"},"\uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0 \uc5c5\ub370\uc774\ud2b8\uac00 \uc644\ub8cc\ub41c \ud6c4 \ud2b8\ub79c\uc7ad\uc158\uc774 \ucee4\ubc0b\ub418\uace0 \ub77d\uc774 \ud574\uc81c\ub41c\ub2e4."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\uc2e4\ud589 \ucffc\ub9ac"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"  -- \uccab \ubc88\uc9f8 \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \ub450 \ubc88\uc9f8 \uc694\uccad\uc758 \ud2b8\ub79c\uc7ad\uc158 \uc2dc\uc791\n  START TRANSACTION\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\uba70 \ubc30\ud0c0 \ub77d \ud68d\ub4dd (getOne)\n  SELECT `coupon`.`id` AS `coupon_id`, `coupon`.`code` AS `coupon_code`, `coupon`.`isRedeemed` AS `coupon_isRedeemed`, `coupon`.`user_id` AS `coupon_user_id`, `coupon`.`version` AS `coupon_version` FROM `coupon` `coupon` WHERE `coupon`.`isRedeemed` = ? ORDER BY `coupon`.`id` ASC FOR UPDATE NOWAIT -- PARAMETERS: [false]\n  -- \ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc5d0\uc11c \ucfe0\ud3f0\uc744 \uc870\ud68c\ud558\uba70 \ubc30\ud0c0 \ub77d\uc744 \ud68d\ub4dd\ud558\ub824\ud558\uc9c0\ub9cc \uc774\ubbf8 \ubc30\ud0c0 \ub77d\uc774 \uac78\ub824\uc788\uace0 `NOWAIT` \uc635\uc158\uc774 \uc124\uc815\ub418\uc5b4 \uc788\uc73c\ubbc0\ub85c \uc989\uc2dc \uc624\ub958 \ubc1c\uc0dd\n  SELECT `coupon`.`id` AS `coupon_id`, `coupon`.`code` AS `coupon_code`, `coupon`.`isRedeemed` AS `coupon_isRedeemed`, `coupon`.`user_id` AS `coupon_user_id`, `coupon`.`version` AS `coupon_version` FROM `coupon` `coupon` WHERE `coupon`.`isRedeemed` = ? ORDER BY `coupon`.`id` ASC FOR UPDATE NOWAIT -- PARAMETERS: [false]\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc758 \uc870\ud68c \ucffc\ub9ac (save)\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`code` AS `Coupon_code`, `Coupon`.`isRedeemed` AS `Coupon_isRedeemed`, `Coupon`.`user_id` AS `Coupon_user_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` IN (?) -- PARAMETERS: [4]\n  -- \ub450 \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc758 \ub864\ubc31 (\uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc758 \ub77d \ud574\uc81c\ub97c \uae30\ub2e4\ub9ac\uc9c0 \uc54a\uace0 \ubc14\ub85c \uc624\ub958\uac00 \ubc1c\uc0dd\ud588\uc73c\ubbc0\ub85c \ub864\ubc31)\n  ROLLBACK\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158\uc758 \uc5c5\ub370\uc774\ud2b8 \ubc0f \uc870\ud68c \ucffc\ub9ac (save)\n  UPDATE `coupon` SET `isRedeemed` = ?, `user_id` = ?, `version` = `version` + 1 WHERE `id` IN (?) -- PARAMETERS: [1,7,4]\n  SELECT `Coupon`.`id` AS `Coupon_id`, `Coupon`.`version` AS `Coupon_version` FROM `coupon` `Coupon` WHERE `Coupon`.`id` = ? -- PARAMETERS: [4]\n  -- \uccab \ubc88\uc9f8 \ud2b8\ub79c\uc7ad\uc158 \ucee4\ubc0b\n  COMMIT\n")))))}C.isMDXComponent=!0}}]);