<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-blockchain/defi/uniswap">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Uniswap | Chihun&#x27;s Dev Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://chihunmanse.github.io/img/m.png"><meta data-rh="true" name="twitter:image" content="https://chihunmanse.github.io/img/m.png"><meta data-rh="true" property="og:url" content="https://chihunmanse.github.io/blockchain/defi/uniswap"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Uniswap | Chihun&#x27;s Dev Blog"><meta data-rh="true" name="description" content="From Constant Product Formula to Concentrated Liquidity - core principles and code analysis of Uniswap"><meta data-rh="true" property="og:description" content="From Constant Product Formula to Concentrated Liquidity - core principles and code analysis of Uniswap"><meta data-rh="true" name="keywords" content="Uniswap,AMM,DEX,DeFi,Constant Product,Concentrated Liquidity,LP,Ethereum"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chihunmanse.github.io/blockchain/defi/uniswap"><link data-rh="true" rel="alternate" href="https://chihunmanse.github.io/blockchain/defi/uniswap" hreflang="en"><link data-rh="true" rel="alternate" href="https://chihunmanse.github.io/blockchain/defi/uniswap" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5b6de4da.css">
<link rel="preload" href="/assets/js/runtime~main.c5ba5f6c.js" as="script">
<link rel="preload" href="/assets/js/main.4ff0f8e6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Chihun&#x27;s Dev Blog</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/tags">Tags</a><a href="https://github.com/chihunmanse" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><b>Chihun&#x27;s Dev Blog</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Home</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/datastructure-algorithm">DataStructure &amp; Algorithm</a><button aria-label="Toggle the collapsible sidebar category &#x27;DataStructure &amp; Algorithm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/backend">Backend</a><button aria-label="Toggle the collapsible sidebar category &#x27;Backend&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/devops">DevOps</a><button aria-label="Toggle the collapsible sidebar category &#x27;DevOps&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/blockchain">BlockChain</a><button aria-label="Toggle the collapsible sidebar category &#x27;BlockChain&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/blockchain/upgradeable-contract">Upgradeable Contract</a><button aria-label="Toggle the collapsible sidebar category &#x27;Upgradeable Contract&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blockchain/contract-error-handling">Contract Error Handling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/blockchain/storage-layout">Solidity Storage Layout</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/blockchain/defi">DeFi</a><button aria-label="Toggle the collapsible sidebar category &#x27;DeFi&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/blockchain/defi/uniswap">Uniswap</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/blockchain/cryptography">Cryptography</a><button aria-label="Toggle the collapsible sidebar category &#x27;Cryptography&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/blockchain/how-ethereum-works">How Ethereum Works</a><button aria-label="Toggle the collapsible sidebar category &#x27;How Ethereum Works&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/blockchain"><span itemprop="name">BlockChain</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/blockchain/defi"><span itemprop="name">DeFi</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Uniswap</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Uniswap</h1><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="amm이란-무엇인가">AMM이란 무엇인가<a href="#amm이란-무엇인가" class="hash-link" aria-label="Direct link to AMM이란 무엇인가" title="Direct link to AMM이란 무엇인가">​</a></h2><p>전통적인 거래소는 <strong>오더북(Order Book)</strong> 방식으로 동작한다. 매수자와 매도자가 각각 원하는 가격과 수량을 제시하고, 가격이 일치하면 거래가 체결된다. 이 방식은 높은 유동성과 정밀한 가격 발견이 가능하지만, 중앙화된 매칭 엔진이 필요하고 충분한 거래량이 없으면 스프레드가 벌어진다.</p><p>블록체인에서 오더북 방식을 구현하면 몇 가지 문제가 발생한다.</p><ul><li><strong>가스 비용</strong>: 주문 생성, 수정, 취소마다 트랜잭션 비용이 발생한다.</li><li><strong>속도</strong>: 블록 생성 시간(이더리움 기준 12초) 동안 가격이 변동하면 불리한 체결이 일어날 수 있다.</li><li><strong>유동성 파편화</strong>: 모든 가격대에 주문이 분산되어 있어야 원활한 거래가 가능하다.</li></ul><p><strong>AMM(Automated Market Maker)</strong>은 이러한 문제를 수학 공식으로 해결한다. 오더북 대신 <strong>유동성 풀(Liquidity Pool)</strong>이라는 토큰 저장소를 두고, 수학 공식에 따라 자동으로 가격을 결정한다. 거래 상대방이 사람이 아니라 스마트 컨트랙트이므로, 언제든 즉시 거래가 가능하다.</p><table><thead><tr><th>특성</th><th>오더북</th><th>AMM</th></tr></thead><tbody><tr><td>가격 결정</td><td>매수/매도 주문 매칭</td><td>수학 공식</td></tr><tr><td>유동성 제공</td><td>마켓 메이커</td><td>누구나 (LP)</td></tr><tr><td>거래 상대방</td><td>다른 트레이더</td><td>스마트 컨트랙트</td></tr><tr><td>항상 거래 가능</td><td>유동성에 의존</td><td>풀에 토큰이 있으면 가능</td></tr></tbody></table><p>Uniswap은 2018년 V1 출시 이후 AMM의 표준을 정립했고, V2(2020)와 V3(2021)를 거치며 DeFi 생태계의 핵심 인프라로 자리잡았다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="uniswap-v2-constant-product-formula">Uniswap V2: Constant Product Formula<a href="#uniswap-v2-constant-product-formula" class="hash-link" aria-label="Direct link to Uniswap V2: Constant Product Formula" title="Direct link to Uniswap V2: Constant Product Formula">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="x--y--k의-의미">x * y = k의 의미<a href="#x--y--k의-의미" class="hash-link" aria-label="Direct link to x * y = k의 의미" title="Direct link to x * y = k의 의미">​</a></h3><p>V2의 핵심은 <strong>Constant Product Formula</strong>다. 두 토큰 X와 Y의 리저브(reserve)를 각각 x, y라 하면, 이 둘의 곱 k는 항상 일정하게 유지된다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">x * y = k</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>예를 들어 ETH/USDC 풀에 10 ETH와 20,000 USDC가 있다면</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">k = 10 * 20,000 = 200,000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>누군가 1 ETH를 넣고 USDC를 받으려 한다. 스왑 후에도 k는 200,000으로 유지되어야 하므로</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(10 + 1) * y&#x27; = 200,000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">y&#x27; = 200,000 / 11 ≈ 18,181.8 USDC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>받을 수 있는 USDC = 20,000 - 18,181.8 = 1,818.2 USDC</p><p>단순히 20,000 / 10 = 2,000 USDC가 아닌 이유는 <strong>슬리피지(Slippage)</strong> 때문이다. 스왑이 풀의 비율을 바꾸기 때문에, 거래 규모가 클수록 불리한 가격을 받게 된다. 이것이 AMM의 본질적인 특성이다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="가격-결정">가격 결정<a href="#가격-결정" class="hash-link" aria-label="Direct link to 가격 결정" title="Direct link to 가격 결정">​</a></h3><p>현재 가격은 두 리저브의 비율이다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ETH 가격 (USDC 기준) = reserveUSDC / reserveETH = 20,000 / 10 = 2,000 USDC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>스왑이 일어나면 리저브 비율이 바뀌고, 따라서 가격도 바뀐다. 1 ETH를 넣은 후</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">새 가격 = 18,181.8 / 11 ≈ 1,653 USDC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>가격이 2,000에서 1,653으로 떨어졌다. 이처럼 AMM에서 거래 자체가 가격을 움직인다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="수수료-구조">수수료 구조<a href="#수수료-구조" class="hash-link" aria-label="Direct link to 수수료 구조" title="Direct link to 수수료 구조">​</a></h3><p>V2는 모든 스왑에 <strong>0.3% 수수료</strong>를 부과한다. 이 수수료는 LP(Liquidity Provider)에게 돌아간다.</p><p>실제 공식에서는 입력 금액의 0.3%를 제외하고 계산한다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">amountInWithFee = amountIn * 997 / 1000  // 0.3% 수수료 제외</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="코드-분석-getamountout">코드 분석: getAmountOut<a href="#코드-분석-getamountout" class="hash-link" aria-label="Direct link to 코드 분석: getAmountOut" title="Direct link to 코드 분석: getAmountOut">​</a></h3><p>V2의 스왑 출력량을 계산하는 핵심 함수를 살펴보자.</p><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">UniswapV2Library.sol</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 입력 금액과 리저브가 주어지면, 출력 금액을 계산한다</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getAmountOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amountIn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// 입력할 토큰 양</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> reserveIn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// 입력 토큰의 리저브</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> reserveOut     </span><span class="token comment" style="color:rgb(98, 114, 164)">// 출력 토큰의 리저브</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">internal</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">pure</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amountOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amountIn </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">reserveIn </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> reserveOut </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2Library: INSUFFICIENT_LIQUIDITY&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 1) 0.3% 수수료를 제외한 입력량 계산</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// amountIn * 0.997 = amountIn * 997 / 1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amountInWithFee </span><span class="token operator">=</span><span class="token plain"> amountIn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">997</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 2) 분자: 수수료 제외 입력량 * 출력 리저브</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> numerator </span><span class="token operator">=</span><span class="token plain"> amountInWithFee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">reserveOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 3) 분모: 입력 리저브 * 1000 + 수수료 제외 입력량</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> denominator </span><span class="token operator">=</span><span class="token plain"> reserveIn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amountInWithFee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 4) 최종 출력량 = 분자 / 분모</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    amountOut </span><span class="token operator">=</span><span class="token plain"> numerator </span><span class="token operator">/</span><span class="token plain"> denominator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>공식 유도 과정</strong></p><p>Constant Product를 유지하면서 수수료를 적용해야 한다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">스왑 전: reserveIn * reserveOut = k</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">스왑 후: (reserveIn + amountIn * 0.997) * (reserveOut - amountOut) = k</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">정리하면:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">amountOut = (amountIn * 0.997 * reserveOut) / (reserveIn + amountIn * 0.997)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          = (amountIn * 997 * reserveOut) / (reserveIn * 1000 + amountIn * 997)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="코드-분석-swap-함수">코드 분석: swap 함수<a href="#코드-분석-swap-함수" class="hash-link" aria-label="Direct link to 코드 분석: swap 함수" title="Direct link to 코드 분석: swap 함수">​</a></h3><p>실제 스왑을 실행하는 Pair 컨트랙트의 <code>swap</code> 함수를 분석해보자.</p><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">UniswapV2Pair.sol</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">swap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount0Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 받을 token0 양</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount1Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 받을 token1 양</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">         </span><span class="token comment" style="color:rgb(98, 114, 164)">// 받을 주소</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">calldata</span><span class="token plain"> data </span><span class="token comment" style="color:rgb(98, 114, 164)">// flash swap용 콜백 데이터</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">external</span><span class="token plain"> lock </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 1) 출력량 검증: 둘 중 하나는 0보다 커야 함</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount0Out </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> amount1Out </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 2) 현재 리저브 조회</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint112</span><span class="token plain"> _reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint112</span><span class="token plain"> _reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getReserves</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 3) 출력량이 리저브보다 작아야 함 (풀에 있는 것보다 많이 빼갈 수 없음)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount0Out </span><span class="token operator">&lt;</span><span class="token plain"> _reserve0 </span><span class="token operator">&amp;&amp;</span><span class="token plain"> amount1Out </span><span class="token operator">&lt;</span><span class="token plain"> _reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2: INSUFFICIENT_LIQUIDITY&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token plain"> _token0 </span><span class="token operator">=</span><span class="token plain"> token0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token plain"> _token1 </span><span class="token operator">=</span><span class="token plain"> token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">to </span><span class="token operator">!=</span><span class="token plain"> _token0 </span><span class="token operator">&amp;&amp;</span><span class="token plain"> to </span><span class="token operator">!=</span><span class="token plain"> _token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2: INVALID_TO&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 4) 토큰 전송 (먼저 보내고 나중에 검증 - Optimistic Transfer)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount0Out </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_safeTransfer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount0Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount1Out </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">_safeTransfer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount1Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 5) Flash Swap 콜백 (data가 있으면 호출)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">length </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IUniswapV2Callee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">uniswapV2Call</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount0Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount1Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 6) 전송 후 잔액 확인</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        balance0 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        balance1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 7) 입력량 계산 (잔액 증가분)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount0In </span><span class="token operator">=</span><span class="token plain"> balance0 </span><span class="token operator">&gt;</span><span class="token plain"> _reserve0 </span><span class="token operator">-</span><span class="token plain"> amount0Out </span><span class="token operator">?</span><span class="token plain"> balance0 </span><span class="token operator">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_reserve0 </span><span class="token operator">-</span><span class="token plain"> amount0Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount1In </span><span class="token operator">=</span><span class="token plain"> balance1 </span><span class="token operator">&gt;</span><span class="token plain"> _reserve1 </span><span class="token operator">-</span><span class="token plain"> amount1Out </span><span class="token operator">?</span><span class="token plain"> balance1 </span><span class="token operator">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_reserve1 </span><span class="token operator">-</span><span class="token plain"> amount1Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount0In </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> amount1In </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2: INSUFFICIENT_INPUT_AMOUNT&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 8) K 값 검증 (수수료 적용 후에도 k가 유지되어야 함)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// balance * 1000 - amountIn * 3 = 수수료(0.3%) 제외한 effective balance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance0Adjusted </span><span class="token operator">=</span><span class="token plain"> balance0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">sub</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount0In</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance1Adjusted </span><span class="token operator">=</span><span class="token plain"> balance1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">sub</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount1In</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 조정된 잔액의 곱이 기존 k * 1000^2 이상이어야 함</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            balance0Adjusted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">balance1Adjusted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1000</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2: K&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 9) 리저브 업데이트</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_update</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">balance0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> balance1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> _reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> _reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">emit</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Swap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount0In</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount1In</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount0Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount1Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>위 코드의 실행 흐름을 보면, 일반적인 &quot;입금 → 검증 → 출금&quot; 순서와 다르다는 것을 알 수 있다. Uniswap V2는 <strong>&quot;출금 → 콜백 → 검증&quot;</strong> 순서로 동작한다. 이 설계가 가능한 이유와 그로 인해 얻는 이점을 살펴보자.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="optimistic-transfer-패턴">Optimistic Transfer 패턴<a href="#optimistic-transfer-패턴" class="hash-link" aria-label="Direct link to Optimistic Transfer 패턴" title="Direct link to Optimistic Transfer 패턴">​</a></h4><p>4번 단계에서 요청한 토큰을 <strong>먼저 전송</strong>한다. 아직 사용자가 입력 토큰을 보냈는지 확인하지 않은 상태다. 이것이 가능한 이유는 8번 단계의 K 검증 때문이다. 트랜잭션이 끝날 때 K 값이 유지(또는 증가)되지 않으면 전체 트랜잭션이 revert된다. 이더리움의 atomic transaction 특성상, 중간에 토큰을 받아갔더라도 최종 검증에 실패하면 모든 상태 변경이 취소된다.</p><p>이 패턴 덕분에 <strong>Flash Swap</strong>이 가능해진다. 5번 단계의 콜백에서 사용자는 방금 받은 토큰으로 다른 작업(차익거래, 담보 청산 등)을 수행하고, 그 수익으로 입력 토큰을 갚을 수 있다. 무담보로 자산을 빌려 사용하고 같은 트랜잭션 내에서 갚는 Flash Loan의 변형이다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="k-검증과-수수료">K 검증과 수수료<a href="#k-검증과-수수료" class="hash-link" aria-label="Direct link to K 검증과 수수료" title="Direct link to K 검증과 수수료">​</a></h4><p>8번 단계의 K 검증은 단순히 <code>x * y &gt;= k</code>가 아니라 수수료를 고려한 조정된 값을 사용한다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">balance0Adjusted = balance0 * 1000 - amount0In * 3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">balance1Adjusted = balance1 * 1000 - amount1In * 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>입력량의 0.3%(3/1000)를 제외한 &quot;effective balance&quot;를 계산하여, 수수료를 제외한 실질 잔액의 곱이 기존 K 값 이상인지 확인한다. 수수료는 풀에 남아 K 값을 증가시키고, 이는 LP들의 수익이 된다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="입력량-역산">입력량 역산<a href="#입력량-역산" class="hash-link" aria-label="Direct link to 입력량 역산" title="Direct link to 입력량 역산">​</a></h4><p>7번 단계에서 입력량을 직접 파라미터로 받지 않고 잔액 변화로 계산한다. <code>swap</code> 함수 호출 전에 토큰을 전송해두면, 함수 내에서 리저브 대비 증가한 잔액을 입력량으로 인식한다.</p><p><strong>장점</strong></p><ul><li>Router 없이 Pair 컨트랙트를 직접 호출할 수 있다.</li><li>여러 스왑을 하나의 트랜잭션으로 체이닝할 수 있다.</li><li>토큰 전송 방식에 유연성을 제공한다. (transfer, transferFrom, 또는 다른 컨트랙트에서 전송)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="lp-토큰-유동성-지분-증명">LP 토큰: 유동성 지분 증명<a href="#lp-토큰-유동성-지분-증명" class="hash-link" aria-label="Direct link to LP 토큰: 유동성 지분 증명" title="Direct link to LP 토큰: 유동성 지분 증명">​</a></h3><p>유동성을 공급하면 LP(Liquidity Provider) 토큰을 받는다. LP 토큰은 풀에 대한 <strong>비례적 지분</strong>을 나타내는 ERC-20 토큰이다. 주식회사의 주식과 비슷하게, LP 토큰을 보유한다는 것은 해당 풀의 자산에 대한 청구권을 갖는다는 의미다.</p><p>핵심은 LP 토큰이 <strong>절대적인 토큰 양이 아니라 비율</strong>을 나타낸다는 점이다. 내가 전체 LP 토큰의 10%를 보유하고 있다면, 출금 시점의 풀 자산 10%를 받는다. 풀에서 스왑이 발생할 때마다 0.3% 수수료가 풀에 누적되므로, 시간이 지나면 같은 LP 토큰으로 더 많은 자산을 인출할 수 있다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="유동성-공급-mint">유동성 공급 (mint)<a href="#유동성-공급-mint" class="hash-link" aria-label="Direct link to 유동성 공급 (mint)" title="Direct link to 유동성 공급 (mint)">​</a></h4><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">UniswapV2Pair.sol</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">mint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">external</span><span class="token plain"> lock </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> liquidity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint112</span><span class="token plain"> _reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint112</span><span class="token plain"> _reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getReserves</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 새로 들어온 토큰 양 계산 (현재 잔액 - 기록된 리저브)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance0 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">token0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount0 </span><span class="token operator">=</span><span class="token plain"> balance0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">sub</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount1 </span><span class="token operator">=</span><span class="token plain"> balance1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">sub</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> _totalSupply </span><span class="token operator">=</span><span class="token plain"> totalSupply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_totalSupply </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 최초 유동성 공급</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        liquidity </span><span class="token operator">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">sqrt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">sub</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">MINIMUM_LIQUIDITY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">_mint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> MINIMUM_LIQUIDITY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 1000 LP 영구 잠금</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 기존 풀에 추가: 더 작은 비율 기준으로 발행</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        liquidity </span><span class="token operator">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            amount0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_totalSupply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> _reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            amount1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_totalSupply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> _reserve1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">liquidity </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_mint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> liquidity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_update</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">balance0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> balance1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> _reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> _reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>최초 유동성 - sqrt 공식의 이유</strong>: 첫 LP에게는 <code>sqrt(amount0 * amount1)</code> 만큼의 LP 토큰이 발행된다. 왜 곱의 제곱근일까?</p><ol><li><strong>단위 독립성</strong>: ETH(18 decimals)와 USDC(6 decimals)처럼 단위가 다른 토큰 페어에서도 공정하게 동작한다. 단순 합이나 곱을 사용하면 decimal이 큰 토큰에 편향된다.</li><li><strong>기하평균의 특성</strong>: <code>sqrt(x * y)</code>는 두 값의 기하평균이다. x가 2배가 되고 y가 절반이 되면 기하평균은 변하지 않아, 가격 변동에 중립적인 지표가 된다.</li><li><strong>K 값과의 관계</strong>: <code>L = sqrt(K)</code>로, 유동성 L의 제곱이 상수 K가 된다. 이 관계는 V3에서 더 명확해진다.</li></ol><p><strong>추가 유동성</strong>: 이미 풀이 존재하면 현재 비율에 맞춰 LP 토큰이 발행된다. <code>Math.min</code>을 사용하는 이유는 비율이 맞지 않게 공급할 경우 초과분을 보호하지 않기 위함이다. 예를 들어 1:1 풀에 2:1 비율로 공급하면, 1:1에 해당하는 LP만 받고 나머지 토큰은 풀에 기부된다. Router 컨트랙트가 이런 실수를 방지해준다.</p><p><strong>MINIMUM_LIQUIDITY</strong>: 최초 1000 LP 토큰(10^-15 수준)은 address(0)에 영구히 잠긴다. 이는 두 가지 문제를 방지한다.</p><ol><li><strong>0 나누기 방지</strong>: totalSupply가 0이 되면 추가 유동성 공급 시 나눗셈 에러가 발생한다.</li><li><strong>Inflation Attack 방지</strong>: 공격자가 최초 LP가 되어 1 wei만 공급하고, 이후 대량의 토큰을 직접 전송하면 LP 토큰 1개의 가치가 극도로 높아진다. 이후 피해자가 유동성을 공급하면 반올림 오차로 LP 토큰을 0개 받게 되어 자금을 잃는다. MINIMUM_LIQUIDITY가 있으면 이 공격의 비용이 높아진다.</li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="유동성-인출-burn">유동성 인출 (burn)<a href="#유동성-인출-burn" class="hash-link" aria-label="Direct link to 유동성 인출 (burn)" title="Direct link to 유동성 인출 (burn)">​</a></h4><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">UniswapV2Pair.sol</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">burn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">external</span><span class="token plain"> lock </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> amount1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint112</span><span class="token plain"> _reserve0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint112</span><span class="token plain"> _reserve1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getReserves</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token plain"> _token0 </span><span class="token operator">=</span><span class="token plain"> token0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token plain"> _token1 </span><span class="token operator">=</span><span class="token plain"> token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance0 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> balance1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> liquidity </span><span class="token operator">=</span><span class="token plain"> balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// 컨트랙트로 전송된 LP 토큰</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint</span><span class="token plain"> _totalSupply </span><span class="token operator">=</span><span class="token plain"> totalSupply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// LP 토큰 비율만큼 각 토큰을 인출</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    amount0 </span><span class="token operator">=</span><span class="token plain"> liquidity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">balance0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> _totalSupply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    amount1 </span><span class="token operator">=</span><span class="token plain"> liquidity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">mul</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">balance1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> _totalSupply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amount0 </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> amount1 </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_burn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> liquidity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_safeTransfer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_safeTransfer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">_token1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> amount1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">_update</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>인출 시에는 보유한 LP 토큰 비율만큼 풀의 자산을 가져간다. 공급 이후 발생한 수수료가 풀에 누적되어 있으므로, 일반적으로 공급했던 것보다 더 많은 토큰을 인출하게 된다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="수수료는-어떻게-lp에게-돌아가는가">수수료는 어떻게 LP에게 돌아가는가<a href="#수수료는-어떻게-lp에게-돌아가는가" class="hash-link" aria-label="Direct link to 수수료는 어떻게 LP에게 돌아가는가" title="Direct link to 수수료는 어떻게 LP에게 돌아가는가">​</a></h4><p>Uniswap V2는 별도의 수수료 분배 로직이 없다. 대신 수수료가 발생하면 K 값 자체가 증가한다.</p><ul><li>스왑 전: K = 1,000,000</li><li>스왑 후 (0.3% 수수료 포함): K = 1,003,000</li></ul><p>K가 커지면 같은 LP 토큰 비율로 더 많은 토큰을 인출할 수 있다. 별도의 claim 함수 없이 인출 시 자동으로 수수료가 포함된다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="v2의-한계-자본-비효율성">V2의 한계: 자본 비효율성<a href="#v2의-한계-자본-비효율성" class="hash-link" aria-label="Direct link to V2의 한계: 자본 비효율성" title="Direct link to V2의 한계: 자본 비효율성">​</a></h2><p>V2는 단순하고 검증된 설계지만, DeFi가 성장하면서 그 한계가 명확해졌다. 핵심 문제는 <strong>자본 비효율성</strong>이다. LP가 공급한 자본 대부분이 실제 거래에 사용되지 않는다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="전-범위-유동성의-문제">전 범위 유동성의 문제<a href="#전-범위-유동성의-문제" class="hash-link" aria-label="Direct link to 전 범위 유동성의 문제" title="Direct link to 전 범위 유동성의 문제">​</a></h3><p><code>x * y = k</code> 공식에서 유동성은 가격 0부터 무한대까지 <strong>균일하게 분포</strong>된다. 수학적으로 이 곡선은 점근선을 가지므로 x가 0이나 무한대에 가까워져도 곡선은 축에 닿지 않는다. 즉, 모든 가격대에 유동성이 존재한다.</p><p>문제는 대부분의 거래가 <strong>현재 가격 근처의 좁은 범위</strong>에서 일어난다는 것이다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">V2 유동성 분포 (ETH/USDC 예시)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Price    $100        $2,000        $100,000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          |            |              |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Liq.     ████████████████████████████████  &lt;- Uniformly distributed</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          |            |              |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Trading             [##]                   &lt;- Most trades here</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 $1,800~$2,200</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ETH가 $2,000일 때, $100이나 $100,000 가격대에 배치된 유동성은 거래에 전혀 기여하지 못한다. 그 자본은 그냥 잠들어 있는 것이다.</p><p><strong>구체적인 수치로 보면</strong>:</p><ul><li>ETH/USDC 풀에 $1,000,000의 유동성이 있다고 가정</li><li>일일 거래의 95%가 현재 가격 ±10% 범위에서 발생</li><li>그 범위에 실제로 활용되는 유동성은 전체의 약 0.5~2% 수준</li><li>나머지 98%의 자본은 극단적 가격 변동에 대비해 묶여 있을 뿐</li></ul><p>스테이블코인 페어의 사례: DAI/USDC 같은 스테이블코인 페어는 0.99~1.01 범위를 거의 벗어나지 않는다. 하지만 V2에서는 0~무한대 전체에 유동성이 분산되어, 전체 자본의 0.5%만 실제 거래에 사용된다. 99.5%의 자본이 사실상 낭비되는 셈이다.</p><p>이 비효율성은 LP의 수익률을 직접적으로 낮춘다. 수수료는 실제 거래에 사용된 유동성에서만 발생하는데, 자본의 극히 일부만 거래에 참여하니 전체 자본 대비 수익률(APR)이 낮아질 수밖에 없다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="비영구적-손실-impermanent-loss">비영구적 손실 (Impermanent Loss)<a href="#비영구적-손실-impermanent-loss" class="hash-link" aria-label="Direct link to 비영구적 손실 (Impermanent Loss)" title="Direct link to 비영구적 손실 (Impermanent Loss)">​</a></h3><p>LP가 직면하는 또 다른 문제는 <strong>비영구적 손실(Impermanent Loss, IL)</strong>이다. 가격이 변동하면, LP는 토큰을 그냥 들고 있었을 때보다 손해를 보게 된다.</p><p>AMM의 특성상 가격이 오르는 토큰은 팔리고, 내리는 토큰은 사들이게 된다. 차익거래자들이 외부 시장과 가격을 맞추는 과정에서 풀의 토큰 비율이 조정된다. 결과적으로 LP는 &quot;오르는 자산은 일찍 팔고, 내리는 자산은 계속 산&quot; 셈이 된다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="수치-예시">수치 예시<a href="#수치-예시" class="hash-link" aria-label="Direct link to 수치 예시" title="Direct link to 수치 예시">​</a></h4><p>ETH 가격이 $2,000 → $4,000로 2배가 된 경우를 계산해보자.</p><p><strong>초기 상태</strong></p><ul><li>LP가 5 ETH + 10,000 USDC를 공급 (총 $20,000)</li><li><code>k = 5 * 10,000 = 50,000</code></li></ul><p><strong>가격 변동 후 풀 상태</strong></p><ul><li>새 가격 p = 4,000에서 <code>x * y = k</code>와 <code>y/x = p</code>를 만족해야 함</li><li><code>x = sqrt(k/p) = sqrt(50,000/4,000) ≈ 3.54 ETH</code></li><li><code>y = sqrt(k*p) = sqrt(50,000*4,000) ≈ 14,142 USDC</code></li></ul><table><thead><tr><th>전략</th><th>보유 자산</th><th>가치</th></tr></thead><tbody><tr><td>단순 보유</td><td>5 ETH + 10,000 USDC</td><td>$30,000</td></tr><tr><td>V2 LP</td><td>3.54 ETH + 14,142 USDC</td><td>$28,284</td></tr></tbody></table><p><strong>손실</strong>: $1,716 (약 5.72%)</p><p>ETH가 올랐는데 LP는 ETH를 1.46개나 덜 갖게 됐다. 차익거래자들이 싼 ETH를 사가면서 풀에서 빠져나갔기 때문이다.</p><p>가격 변동이 클수록 비영구적 손실도 커진다. 변동성이 큰 토큰 페어의 LP는 수수료 수익이 손실을 상쇄하고도 남아야 수익을 낼 수 있다. &quot;비영구적&quot;이라 부르는 이유는 가격이 원래대로 돌아오면 손실이 사라지기 때문이다. 하지만 현실에서 가격이 정확히 원점으로 돌아오는 경우는 드물다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="uniswap-v3-concentrated-liquidity">Uniswap V3: Concentrated Liquidity<a href="#uniswap-v3-concentrated-liquidity" class="hash-link" aria-label="Direct link to Uniswap V3: Concentrated Liquidity" title="Direct link to Uniswap V3: Concentrated Liquidity">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="핵심-아이디어">핵심 아이디어<a href="#핵심-아이디어" class="hash-link" aria-label="Direct link to 핵심 아이디어" title="Direct link to 핵심 아이디어">​</a></h3><p>V3의 혁신은 <strong>Concentrated Liquidity</strong>다. LP가 원하는 가격 범위에만 유동성을 집중할 수 있다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">V2: Full Range Distribution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|================================================|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">0                     Price                      ∞</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[          Liquidity spread across all prices    ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">V3: Concentrated in Selected Range</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    |==========|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  $1,800     $2,200</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  [Deep liquidity here]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>V2에서 $10,000를 공급하면 전 가격대에 얇게 분산된다. V3에서는 같은 $10,000를 $1,800~$2,200 범위에만 집중할 수 있어, 해당 범위 내에서 훨씬 깊은 유동성을 제공한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="수학적-기반-virtual-liquidity">수학적 기반: Virtual Liquidity<a href="#수학적-기반-virtual-liquidity" class="hash-link" aria-label="Direct link to 수학적 기반: Virtual Liquidity" title="Direct link to 수학적 기반: Virtual Liquidity">​</a></h3><p>V3의 concentrated liquidity를 이해하려면 <strong>가상 유동성(Virtual Liquidity)</strong> 개념이 필요하다.</p><p>V2의 <code>x * y = k</code>를 다시 보자. 이 공식에서 유동성 L은 <code>L = sqrt(k) = sqrt(x * y)</code>로 정의된다.</p><p>V2에서는 전체 가격 범위(0~∞)에 L이 균일하게 분포한다. 가격 P에서 토큰 양과의 관계는 다음과 같다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">x = L / sqrt(P)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">y = L * sqrt(P)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>V3의 핵심 통찰은 <strong>특정 가격 범위 <!-- -->[Pa, Pb]<!-- -->에서만 동작하는 &quot;가상의&quot; x, y를 사용하면, 더 적은 실제 자본으로 같은 유동성 L을 제공할 수 있다</strong>는 것이다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="real-vs-virtual-reserves">Real vs Virtual Reserves<a href="#real-vs-virtual-reserves" class="hash-link" aria-label="Direct link to Real vs Virtual Reserves" title="Direct link to Real vs Virtual Reserves">​</a></h4><p>V3에서 LP가 범위 <!-- -->[Pa, Pb]<!-- -->에 유동성 L을 공급할 때 필요한 토큰 양은 다음과 같다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Virtual reserves (V2처럼 동작):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">x_virtual = L / sqrt(P)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">y_virtual = L * sqrt(P)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Real reserves (실제 필요한 토큰):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">x_real = L * (1/sqrt(P) - 1/sqrt(Pb))   # 가격이 Pb에 도달하면 x가 0이 됨</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">y_real = L * (sqrt(P) - sqrt(Pa))        # 가격이 Pa에 도달하면 y가 0이 됨</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>범위가 좁을수록 실제 필요한 토큰(x_real, y_real)이 줄어들지만, 가상 리저브(x_virtual, y_virtual)는 같은 L을 유지한다. 스왑 시에는 가상 리저브 기준으로 가격이 결정되므로, 적은 자본으로 깊은 유동성 효과를 낸다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="범위-이탈-시-동작">범위 이탈 시 동작<a href="#범위-이탈-시-동작" class="hash-link" aria-label="Direct link to 범위 이탈 시 동작" title="Direct link to 범위 이탈 시 동작">​</a></h4><p>가격이 범위를 벗어나면 포지션은 단일 토큰으로 변환된다.</p><ul><li>가격 &lt; Pa (범위 하단 이탈): y_real = 0, 전부 토큰 X로 변환</li><li>가격 &gt; Pb (범위 상단 이탈): x_real = 0, 전부 토큰 Y로 변환</li></ul><p>범위를 벗어난 포지션은 거래에 참여하지 않으므로 수수료도 발생하지 않는다. 가격이 다시 범위 안으로 들어오면 거래에 참여하기 시작한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tick-시스템">Tick 시스템<a href="#tick-시스템" class="hash-link" aria-label="Direct link to Tick 시스템" title="Direct link to Tick 시스템">​</a></h3><p>V3는 연속적인 가격 대신 <strong>Tick</strong>이라는 이산적 가격 포인트를 사용한다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Tick: ..., -2, -1, 0, 1, 2, ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">각 Tick은 특정 가격에 대응:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">price(i) = 1.0001^i</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Tick 0  → 가격 1.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Tick 1  → 가격 1.0001</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Tick 100 → 가격 1.0100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Tick -100 → 가격 0.9900</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>LP는 두 Tick을 선택하여 유동성 범위를 지정한다. 예를 들어 Tick -100 ~ +100은 가격 0.99 ~ 1.01 범위를 의미한다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="tick-spacing">Tick Spacing<a href="#tick-spacing" class="hash-link" aria-label="Direct link to Tick Spacing" title="Direct link to Tick Spacing">​</a></h4><p>모든 Tick에서 유동성을 설정할 수 있다면, 각 Tick마다 상태를 업데이트해야 해서 가스 비용이 폭증한다. V3는 <strong>Tick Spacing</strong>을 도입해 사용 가능한 Tick을 제한한다.</p><table><thead><tr><th>수수료</th><th>Tick Spacing</th><th>범위당 Tick 수</th><th>설계 의도</th></tr></thead><tbody><tr><td>0.01%</td><td>1</td><td>모든 Tick</td><td>최고 정밀도, 스테이블코인 전용</td></tr><tr><td>0.05%</td><td>10</td><td>1/10</td><td>스테이블코인 (정밀한 범위 필요)</td></tr><tr><td>0.30%</td><td>60</td><td>1/60</td><td>일반 페어 (가스/정밀도 균형)</td></tr><tr><td>1.00%</td><td>200</td><td>1/200</td><td>변동성 높은 페어 (넓은 범위)</td></tr></tbody></table><p>Tick Spacing이 60이면 ..., -120, -60, 0, 60, 120, ... 이런 Tick만 범위 경계로 사용 가능하다. 낮은 수수료 풀은 좁은 범위에서 정교한 LP 전략이 필요하므로 세밀한 Tick을, 높은 수수료 풀은 어차피 넓은 범위를 쓰므로 거친 Tick을 제공한다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="initialized-tick">Initialized Tick<a href="#initialized-tick" class="hash-link" aria-label="Direct link to Initialized Tick" title="Direct link to Initialized Tick">​</a></h4><p>모든 Tick에 데이터를 저장하면 메모리 낭비다. V3는 <strong>유동성 변화가 있는 Tick만 초기화</strong>한다. 이를 Initialized Tick이라 한다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">예: 어떤 LP가 Tick 100~200 범위에 유동성 공급</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Tick 100: liquidityNet = +1000 (이 Tick을 지나갈 때 유동성 +1000)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Tick 200: liquidityNet = -1000 (이 Tick을 지나갈 때 유동성 -1000)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">중간의 Tick 101~199는 초기화하지 않음</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>스왑이 Tick을 지나갈 때 해당 Tick의 <code>liquidityNet</code>을 현재 유동성에 더하거나 빼면서 유동성을 추적한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sqrtpricex96">sqrtPriceX96<a href="#sqrtpricex96" class="hash-link" aria-label="Direct link to sqrtPriceX96" title="Direct link to sqrtPriceX96">​</a></h3><p>V3는 가격을 직접 저장하지 않고 <strong>sqrtPriceX96</strong>을 저장한다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sqrtPriceX96 = sqrt(price) * 2^96</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="왜-제곱근인가">왜 제곱근인가?<a href="#왜-제곱근인가" class="hash-link" aria-label="Direct link to 왜 제곱근인가?" title="Direct link to 왜 제곱근인가?">​</a></h4><p>유동성 계산 공식을 다시 보자.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">x = L / sqrt(P)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">y = L * sqrt(P)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>토큰 양을 계산할 때 항상 <code>sqrt(P)</code>가 필요하다. 가격 P를 저장하면 매번 제곱근 연산(가스 비쌈)을 해야 한다. <code>sqrt(P)</code>를 저장하면 바로 사용할 수 있다.</p><p>또한 스왑 시 가격 변화량 계산에서도 제곱근 형태가 더 편리하다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">deltaX = L * (1/sqrt(P_new) - 1/sqrt(P_old))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deltaY = L * (sqrt(P_new) - sqrt(P_old))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="왜-296인가">왜 2^96인가?<a href="#왜-296인가" class="hash-link" aria-label="Direct link to 왜 2^96인가?" title="Direct link to 왜 2^96인가?">​</a></h4><p>Solidity는 부동소수점을 지원하지 않으므로 <strong>고정소수점(Fixed-Point)</strong> 표기를 사용한다. 2^96을 곱해 정수로 표현하면 충분한 정밀도를 확보하면서 uint160 범위 내에서 연산할 수 있다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="v3-스왑-메커니즘">V3 스왑 메커니즘<a href="#v3-스왑-메커니즘" class="hash-link" aria-label="Direct link to V3 스왑 메커니즘" title="Direct link to V3 스왑 메커니즘">​</a></h3><p>V3 스왑은 V2보다 복잡하다. 가격 범위를 넘나들며 여러 포지션의 유동성을 순차적으로 소비하기 때문이다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="스왑-흐름">스왑 흐름<a href="#스왑-흐름" class="hash-link" aria-label="Direct link to 스왑 흐름" title="Direct link to 스왑 흐름">​</a></h4><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">스왑 요청: 1 ETH → USDC</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. 현재 가격(Tick)에서 시작</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. 현재 활성 유동성(L)으로 스왑 가능한 만큼 스왑</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. 가격이 다음 초기화된 Tick에 도달하면:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   - 해당 Tick의 liquidityNet을 현재 L에 적용</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   - 새로운 L로 스왑 계속</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">4. 입력 토큰이 소진될 때까지 반복</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>예를 들어 ETH를 USDC로 스왑하면 가격이 하락한다(ETH 공급 증가, USDC 수요 증가). 가격이 하락하며 여러 LP 포지션의 범위를 지나갈 수 있다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="liquidity-변수의-의미">liquidity 변수의 의미<a href="#liquidity-변수의-의미" class="hash-link" aria-label="Direct link to liquidity 변수의 의미" title="Direct link to liquidity 변수의 의미">​</a></h4><p>Pool의 <code>liquidity</code> 상태 변수는 <strong>현재 가격이 속한 범위에 걸친 모든 포지션의 유동성 합</strong>이다.</p><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 현재 Tick = 100이고, 아래 포지션들이 있다면:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 포지션 A: Tick 50~150, L = 1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 포지션 B: Tick 80~120, L = 2000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 포지션 C: Tick 200~300, L = 500 (현재 범위 밖)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// liquidity = 1000 + 2000 = 3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// (포지션 C는 현재 가격이 범위 밖이므로 제외)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>스왑이 Tick을 지나갈 때마다 <code>liquidity</code>가 업데이트된다. 이 값이 클수록 해당 가격대의 슬리피지가 작아진다.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="단일-tick-내-스왑-계산">단일 Tick 내 스왑 계산<a href="#단일-tick-내-스왑-계산" class="hash-link" aria-label="Direct link to 단일 Tick 내 스왑 계산" title="Direct link to 단일 Tick 내 스왑 계산">​</a></h4><p>가격이 하나의 Tick 범위 내에서만 움직이는 경우, V2와 유사하게 계산된다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">X를 Y로 스왑할 때 (가격 하락 방향):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deltaY = L * (sqrt(P_old) - sqrt(P_new))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Y를 X로 스왑할 때 (가격 상승 방향):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deltaX = L * (1/sqrt(P_new) - 1/sqrt(P_old))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>L</code>이 클수록 같은 가격 변화에 더 많은 토큰을 교환할 수 있다. 이것이 concentrated liquidity의 핵심이다. 좁은 범위에 L을 집중하면 해당 범위에서 깊은 유동성(낮은 슬리피지)을 제공한다.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="다중-수수료-티어">다중 수수료 티어<a href="#다중-수수료-티어" class="hash-link" aria-label="Direct link to 다중 수수료 티어" title="Direct link to 다중 수수료 티어">​</a></h3><p>V2는 0.3% 고정이었지만, V3는 세 가지 수수료 티어를 제공한다.</p><table><thead><tr><th>티어</th><th>적합한 페어</th><th>이유</th></tr></thead><tbody><tr><td>0.05%</td><td>USDC/DAI</td><td>가격 변동 거의 없음, 낮은 IL</td></tr><tr><td>0.30%</td><td>ETH/USDC</td><td>일반적인 변동성</td></tr><tr><td>1.00%</td><td>SHIB/ETH</td><td>높은 변동성, 높은 IL 보상 필요</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="nft-기반-포지션">NFT 기반 포지션<a href="#nft-기반-포지션" class="hash-link" aria-label="Direct link to NFT 기반 포지션" title="Direct link to NFT 기반 포지션">​</a></h3><p>V2에서 LP 토큰은 ERC-20이었다. 모든 LP가 동일한 범위(전체)에 유동성을 제공하므로, 대체 가능(fungible)했다.</p><p>V3에서 각 LP 포지션은 고유한 범위를 가지므로, <strong>ERC-721 NFT</strong>로 표현된다.</p><ul><li>token0, token1 (토큰 쌍)</li><li>tickLower, tickUpper (가격 범위)</li><li>liquidity (유동성 양)</li><li>feeGrowthInside (수수료 누적)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="v3-pool-구조">V3 Pool 구조<a href="#v3-pool-구조" class="hash-link" aria-label="Direct link to V3 Pool 구조" title="Direct link to V3 Pool 구조">​</a></h3><p>V3 Pool의 핵심 상태 변수를 살펴보자.</p><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">UniswapV3Pool.sol - 상태 변수</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 현재 가격과 틱 정보를 담은 슬롯</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name">Slot0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint160</span><span class="token plain"> sqrtPriceX96</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">           </span><span class="token comment" style="color:rgb(98, 114, 164)">// 현재 가격의 제곱근 * 2^96</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">int24</span><span class="token plain"> tick</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(98, 114, 164)">// 현재 틱</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint16</span><span class="token plain"> observationIndex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">         </span><span class="token comment" style="color:rgb(98, 114, 164)">// 오라클 관측 인덱스</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint16</span><span class="token plain"> observationCardinality</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// 오라클 배열 크기</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint16</span><span class="token plain"> observationCardinalityNext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint8</span><span class="token plain"> feeProtocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">              </span><span class="token comment" style="color:rgb(98, 114, 164)">// 프로토콜 수수료</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"> unlocked</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(98, 114, 164)">// 재진입 방지</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Slot0 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> slot0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 현재 활성 유동성 (현재 가격 범위에 걸친 유동성 합계)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin" style="color:rgb(189, 147, 249)">uint128</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> liquidity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 틱별 정보: 해당 틱을 경계로 하는 포지션들의 유동성 합</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mapping</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">int24</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> Tick</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> ticks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 포지션별 정보: (owner, tickLower, tickUpper) → 포지션 데이터</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mapping</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">bytes32</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> Position</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> positions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="테스트">테스트<a href="#테스트" class="hash-link" aria-label="Direct link to 테스트" title="Direct link to 테스트">​</a></h2><p>메인넷 포크 환경에서 V2 공식을 검증하고 V2/V3 스왑 결과를 비교해보자.</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">V2 공식 검증</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">V2 vs V3 스왑 비교</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">UniswapComparison.t.sol</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">test_V2_GetAmountOutFormula</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">view</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> amountIn </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> ether</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// V2 공식 직접 계산</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> amountInWithFee </span><span class="token operator">=</span><span class="token plain"> amountIn </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">997</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> numerator </span><span class="token operator">=</span><span class="token plain"> amountInWithFee </span><span class="token operator">*</span><span class="token plain"> reserveOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> denominator </span><span class="token operator">=</span><span class="token plain"> reserveIn </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1000</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> amountInWithFee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> amountOut </span><span class="token operator">=</span><span class="token plain"> numerator </span><span class="token operator">/</span><span class="token plain"> denominator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Router의 결과와 비교</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">memory</span><span class="token plain"> routerAmounts </span><span class="token operator">=</span><span class="token plain"> v2Router</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getAmountsOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amountIn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">assertEq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">amountOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routerAmounts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">UniswapComparison.t.sol</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">test_SwapComparison</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> amountIn </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> ether</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> halfAmount </span><span class="token operator">=</span><span class="token plain"> amountIn </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// V2 스왑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">WETH</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">approve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v2Router</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> halfAmount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    v2Router</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">swapExactTokensForTokens</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">halfAmount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> block</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> v2Output </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">USDC</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">balanceOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// V3 스왑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">IERC20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">WETH</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">approve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v3Router</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> halfAmount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint256</span><span class="token plain"> v3Output </span><span class="token operator">=</span><span class="token plain"> v3Router</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">exactInputSingle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ISwapRouter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ExactInputSingleParams</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            tokenIn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WETH</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            tokenOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> USDC</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            fee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            recipient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            deadline</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> block</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            amountIn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> halfAmount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            amountOutMinimum</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            sqrtPriceLimitX96</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">npm</span><span class="token plain"> run test:uniswap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[PASS] test_V2_GetAmountOutFormula()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  amountIn: 1000000000000000000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  reserveIn (WETH): 3563038037535649675241</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  reserveOut (USDC): 11441088302021</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  amountOut = (amountIn * 997 * reserveOut) / (reserveIn * 1000 + amountIn * 997)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Router getAmountsOut: 3200519893</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Manual calculation:   3200519893</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Match: true</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[PASS] test_SwapComparison()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  === Swap Comparison: 1 WETH -&gt; USDC ===</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  V2 actual output (0.5 WETH): 1600483805 USDC</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  V3 actual output (0.5 WETH): 1600561197 USDC</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  V3 gave 77392 more USDC (0.005% more efficient)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>V3가 동일 입력에 더 많은 출력을 주는 이유는 concentrated liquidity 덕분에 현재 가격대의 유동성이 더 깊기 때문이다.</p><p>전체 코드는 <a href="https://github.com/chihunmanse/crypto-examples/tree/main/solidity-examples/test/foundry" target="_blank" rel="noopener noreferrer">crypto-examples/solidity-examples</a>에서 확인할 수 있다.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="정리">정리<a href="#정리" class="hash-link" aria-label="Direct link to 정리" title="Direct link to 정리">​</a></h2><table><thead><tr><th>항목</th><th>V2</th><th>V3</th></tr></thead><tbody><tr><td>유동성 분포</td><td>0 ~ ∞ 전 범위 균일</td><td>사용자 지정 범위 집중</td></tr><tr><td>자본 효율성</td><td>기준 (1x)</td><td>최대 4000x</td></tr><tr><td>LP 토큰</td><td>ERC-20 (대체 가능)</td><td>ERC-721 NFT (고유)</td></tr><tr><td>수수료</td><td>0.3% 고정</td><td>0.05%, 0.3%, 1% 선택</td></tr><tr><td>LP 관리</td><td>Passive (설정 후 방치)</td><td>Active (범위 조정 필요)</td></tr><tr><td>비영구적 손실</td><td>기본</td><td>범위 이탈 시 증폭</td></tr><tr><td>가스 비용</td><td>상대적 저렴</td><td>상대적 비쌈</td></tr><tr><td>복잡도</td><td>단순</td><td>복잡</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="참고-자료">참고 자료<a href="#참고-자료" class="hash-link" aria-label="Direct link to 참고 자료" title="Direct link to 참고 자료">​</a></h3><ul><li><a href="https://app.uniswap.org/whitepaper.pdf" target="_blank" rel="noopener noreferrer">Uniswap V2 Whitepaper</a></li><li><a href="https://app.uniswap.org/whitepaper-v3.pdf" target="_blank" rel="noopener noreferrer">Uniswap V3 Whitepaper</a></li><li><a href="https://docs.uniswap.org/contracts/v2/concepts/protocol-overview/how-uniswap-works" target="_blank" rel="noopener noreferrer">Uniswap Docs - How Uniswap Works</a></li><li><a href="https://docs.uniswap.org/concepts/protocol/concentrated-liquidity" target="_blank" rel="noopener noreferrer">Uniswap Docs - Concentrated Liquidity</a></li><li><a href="https://rareskills.io/post/uniswap-v3-concentrated-liquidity" target="_blank" rel="noopener noreferrer">RareSkills - Uniswap V3 Concentrated Liquidity</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/de-fi">DeFi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ethereum">Ethereum</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/solidity">Solidity</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/uniswap">Uniswap</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blockchain/defi"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">DeFi</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blockchain/cryptography"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cryptography</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#amm이란-무엇인가" class="table-of-contents__link toc-highlight">AMM이란 무엇인가</a></li><li><a href="#uniswap-v2-constant-product-formula" class="table-of-contents__link toc-highlight">Uniswap V2: Constant Product Formula</a><ul><li><a href="#x--y--k의-의미" class="table-of-contents__link toc-highlight">x * y = k의 의미</a></li><li><a href="#가격-결정" class="table-of-contents__link toc-highlight">가격 결정</a></li><li><a href="#수수료-구조" class="table-of-contents__link toc-highlight">수수료 구조</a></li><li><a href="#코드-분석-getamountout" class="table-of-contents__link toc-highlight">코드 분석: getAmountOut</a></li><li><a href="#코드-분석-swap-함수" class="table-of-contents__link toc-highlight">코드 분석: swap 함수</a></li><li><a href="#lp-토큰-유동성-지분-증명" class="table-of-contents__link toc-highlight">LP 토큰: 유동성 지분 증명</a></li></ul></li><li><a href="#v2의-한계-자본-비효율성" class="table-of-contents__link toc-highlight">V2의 한계: 자본 비효율성</a><ul><li><a href="#전-범위-유동성의-문제" class="table-of-contents__link toc-highlight">전 범위 유동성의 문제</a></li><li><a href="#비영구적-손실-impermanent-loss" class="table-of-contents__link toc-highlight">비영구적 손실 (Impermanent Loss)</a></li></ul></li><li><a href="#uniswap-v3-concentrated-liquidity" class="table-of-contents__link toc-highlight">Uniswap V3: Concentrated Liquidity</a><ul><li><a href="#핵심-아이디어" class="table-of-contents__link toc-highlight">핵심 아이디어</a></li><li><a href="#수학적-기반-virtual-liquidity" class="table-of-contents__link toc-highlight">수학적 기반: Virtual Liquidity</a></li><li><a href="#tick-시스템" class="table-of-contents__link toc-highlight">Tick 시스템</a></li><li><a href="#sqrtpricex96" class="table-of-contents__link toc-highlight">sqrtPriceX96</a></li><li><a href="#v3-스왑-메커니즘" class="table-of-contents__link toc-highlight">V3 스왑 메커니즘</a></li><li><a href="#다중-수수료-티어" class="table-of-contents__link toc-highlight">다중 수수료 티어</a></li><li><a href="#nft-기반-포지션" class="table-of-contents__link toc-highlight">NFT 기반 포지션</a></li><li><a href="#v3-pool-구조" class="table-of-contents__link toc-highlight">V3 Pool 구조</a></li></ul></li><li><a href="#테스트" class="table-of-contents__link toc-highlight">테스트</a></li><li><a href="#정리" class="table-of-contents__link toc-highlight">정리</a><ul><li><a href="#참고-자료" class="table-of-contents__link toc-highlight">참고 자료</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.c5ba5f6c.js"></script>
<script src="/assets/js/main.4ff0f8e6.js"></script>
</body>
</html>